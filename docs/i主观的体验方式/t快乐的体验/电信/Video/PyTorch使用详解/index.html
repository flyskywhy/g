<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-i主观的体验方式/t快乐的体验/电信/Video/PyTorch使用详解" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.1">
<title data-rh="true">PyTorch使用详解 | My Site</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://flyskywhy.github.io/g/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://flyskywhy.github.io/g/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://flyskywhy.github.io/g/docs/i主观的体验方式/t快乐的体验/电信/Video/PyTorch使用详解"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="PyTorch使用详解 | My Site"><meta data-rh="true" name="description" content="Li Zheng flyskywhy@gmail.com"><meta data-rh="true" property="og:description" content="Li Zheng flyskywhy@gmail.com"><link data-rh="true" rel="icon" href="/g/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://flyskywhy.github.io/g/docs/i主观的体验方式/t快乐的体验/电信/Video/PyTorch使用详解"><link data-rh="true" rel="alternate" href="https://flyskywhy.github.io/g/docs/i主观的体验方式/t快乐的体验/电信/Video/PyTorch使用详解" hreflang="en"><link data-rh="true" rel="alternate" href="https://flyskywhy.github.io/g/docs/i主观的体验方式/t快乐的体验/电信/Video/PyTorch使用详解" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"PyTorch使用详解","item":"https://flyskywhy.github.io/g/docs/i主观的体验方式/t快乐的体验/电信/Video/PyTorch使用详解"}]}</script><link rel="alternate" type="application/rss+xml" href="/g/blog/rss.xml" title="My Site RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/g/blog/atom.xml" title="My Site Atom Feed"><link rel="stylesheet" href="/g/assets/css/styles.faf98e1c.css">
<script src="/g/assets/js/runtime~main.41f3182f.js" defer="defer"></script>
<script src="/g/assets/js/main.fd282c03.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/g/img/logo.png"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/g/"><div class="navbar__logo"><img src="/g/img/logo.png" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/g/img/logo.png" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">My Site</b></a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/g/docs/">文档</a><a href="https://github.com/flyskywhy/g" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/g/docs/"><span title="README" class="linkLabel_WmDU">README</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/g/docs/i主观的体验方式/i悲伤的体验/中医/中药的“威力”"><span title="i主观的体验方式" class="categoryLinkLabel_W154">i主观的体验方式</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/g/docs/i主观的体验方式/i悲伤的体验/中医/中药的“威力”"><span title="i悲伤的体验" class="categoryLinkLabel_W154">i悲伤的体验</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/商/Pm/小团队项目管理软件的的选择"><span title="t快乐的体验" class="categoryLinkLabel_W154">t快乐的体验</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/商/Pm/小团队项目管理软件的的选择"><span title="商" class="categoryLinkLabel_W154">商</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/处世/如何做好人生最重要的事——选择"><span title="处世" class="categoryLinkLabel_W154">处世</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/手机/手机投屏到手机的方法"><span title="手机" class="categoryLinkLabel_W154">手机</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/政/atLJJ"><span title="政" class="categoryLinkLabel_W154">政</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/电信/Cpu/Riscv/LicheeRV使用详解"><span title="电信" class="categoryLinkLabel_W154">电信</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-4 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/电信/Cpu/Riscv/LicheeRV使用详解"><span title="Cpu" class="categoryLinkLabel_W154">Cpu</span></a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/电信/Education/"><span title="README" class="linkLabel_WmDU">README</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-4 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/电信/Fs/Ipfs/Ipfs使用详解"><span title="Fs" class="categoryLinkLabel_W154">Fs</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-4 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/电信/Net/Vpn/VPN路由设置详解"><span title="Net" class="categoryLinkLabel_W154">Net</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-4 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/电信/Os/AliOsThings/BoneEngine使用详解"><span title="Os" class="categoryLinkLabel_W154">Os</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-4 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/电信/Test/Firebase使用详解"><span title="Test" class="categoryLinkLabel_W154">Test</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-4 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/电信/Tool/Probe/Fs2/mips仿真器gdb调试方法"><span title="Tool" class="categoryLinkLabel_W154">Tool</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-4 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/电信/Video/PyTorch使用详解"><span title="Video" class="categoryLinkLabel_W154">Video</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/电信/Video/PyTorch使用详解"><span title="PyTorch使用详解" class="linkLabel_WmDU">PyTorch使用详解</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/电信/Video/QuickCut使用详解"><span title="QuickCut使用详解" class="linkLabel_WmDU">QuickCut使用详解</span></a></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/画/Ai/fastsdcpu使用详解"><span title="画" class="categoryLinkLabel_W154">画</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/行/杭州老和山游步道、杭州乐园2日游"><span title="行" class="categoryLinkLabel_W154">行</span></a></div></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/g/docs/t客观的存在原理/i人体内部的存在/t肉体/现代医学的哲学理念"><span title="t客观的存在原理" class="categoryLinkLabel_W154">t客观的存在原理</span></a></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/g/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">i主观的体验方式</span></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">t快乐的体验</span></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">电信</span></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Video</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">PyTorch使用详解</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><p>Li Zheng <a href="mailto:flyskywhy@gmail.com" target="_blank" rel="noopener noreferrer">flyskywhy@gmail.com</a></p>
<header><h1>PyTorch 使用详解</h1></header>
<p>本文先介绍了一些 YOLO 模型在手机上的使用过程，再在“ YOLO 代码大致流程”一节中介绍了 PyTorch 的一些基本概念。</p>
<p>PyTorch 也可以用于训练其它深度学习模型，本文只介绍用于训练 YOLO 模型。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="深度学习现状">深度学习现状<a href="#深度学习现状" class="hash-link" aria-label="Direct link to 深度学习现状" title="Direct link to 深度学习现状" translate="no">​</a></h2>
<p>深度学习的使用过程可以分为训练和部署两个阶段。</p>
<p>训练阶段是通过标注好各种物体位置和名称的大量旧照片训练（train）出模型文件也就是适合自己业务的权重（weight）文件。</p>
<p>部署阶段是在实际开展业务的设备上运行模型文件以推理（inference）识别出新照片中物体的位置和名称。</p>
<p>训练阶段所用的设备一般是安装有 GPU 的电脑，以让训练能够通过 GPU 将原本几小时的训练加速至几分钟。</p>
<p>部署阶段所用的设备一般是嵌入式设备或是 Android 设备或是电脑。</p>
<p>训练阶段所用的代码框架一般用的是 Meta 公司的 PyTorch ； Google 公司的 Tensor Flow 简称 TF 由于源代码质量不高以及其 1.0 和 2.0 版本 API 不兼容等原因，现已慢慢乏人使用；以及只用于 YOLO 模型的 <a href="https://github.com/AlexeyAB/darknet" target="_blank" rel="noopener noreferrer">darknet</a>。</p>
<p>部署阶段所用的代码框架一般用的是 Meta 公司的 PlayTorch ，可以参考其在 <a href="https://playtorch.dev/docs/tutorials/snacks/yolov5/" target="_blank" rel="noopener noreferrer">https://playtorch.dev/docs/tutorials/snacks/yolov5/</a> 中如何使用 <code>react-native-pytorch-core</code> ；如果追求 Android 手机上实时推理速度的，可以使用 <a href="https://github.com/flyskywhy/YOLOv5-Lite" target="_blank" rel="noopener noreferrer">https://github.com/flyskywhy/YOLOv5-Lite</a> 和 <a href="https://github.com/flyskywhy/Yolo-FastestV2" target="_blank" rel="noopener noreferrer">https://github.com/flyskywhy/Yolo-FastestV2</a> 所用的腾讯公司的 NCNN ；至于 Google 的 TF lite ，在部署上曾有先发优势，但由于源代码质量不高以及其 1.0 和 2.0 版本 API 不兼容等原因，现已慢慢乏人使用，不过如果用于 Web 的话可能还是需要 <code>tf.js</code> 。</p>
<p>另，标注是人工智能中的“人工”阶段，可以参考<a href="https://blog.csdn.net/qq_34806812/article/details/81394646" target="_blank" rel="noopener noreferrer">深度学习图像标注工具汇总</a>和<a href="https://mp.weixin.qq.com/s/ii22i3dSauoSCmhLjNUo-w" target="_blank" rel="noopener noreferrer">LabelBee 让人工标注更智能</a>。如果没有足够的照片而且目标尺寸较小使得在一张高分辨率照片中有许多目标，则也可以使用类似<a href="https://uutool.cn/img-incision/" target="_blank" rel="noopener noreferrer">在线图片水平_垂直均等切割工具</a>来切割出几百张照片以进行训练。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="react-native-pytorch-core-与-yolov5"><code>react-native-pytorch-core</code> 与 <code>yolov5</code><a href="#react-native-pytorch-core-与-yolov5" class="hash-link" aria-label="Direct link to react-native-pytorch-core-与-yolov5" title="Direct link to react-native-pytorch-core-与-yolov5" translate="no">​</a></h2>
<p>参考 <a href="/g/docs/i主观的体验方式/t快乐的体验/电信/Tool/编程语言/Python/Python使用详解">Python 使用详解</a> 安装 Python 。</p>
<p>参考 <a href="https://github.com/flyskywhy/wrgb" target="_blank" rel="noopener noreferrer">wrgb dataset</a> 数据集训练出 <code>yolov5s.ptl</code> 。</p>
<p>参考 <a href="https://playtorch.dev/docs/tutorials/snacks/yolov5/" target="_blank" rel="noopener noreferrer">https://playtorch.dev/docs/tutorials/snacks/yolov5/</a> 在手机 APP 中使用 <code>yolov5s.ptl</code> 并在其中的</p>
<p>await model.forward(formattedInputTensor)</p>
<p>前后加上 <code>console.time(&#x27;detect&#x27;);</code> 和 <code>console.timeEnd(&#x27;detect&#x27;);</code>，在其中的</p>
<p>outputsToNMSPredictions()</p>
<p>前后加上 <code>console.time(&#x27;NMS&#x27;);</code> 和 <code>console.timeEnd(&#x27;NMS&#x27;);</code>，并将 <code>nMSLimit</code> 设为 200 ，此时在高通骁龙 888 上测得</p>
<p>detect: 370ms
NMS: 6300ms</p>
<p>注，如果上面在 <code>python export.py --weights runs/yolov5s_wrgb/exp/weights/best.pt --include torchscript</code> 时加上了参数 <code> --img-size 416</code> ，则需要在 JS 代码中将 <code>const IMAGE_SIZE = 640</code> 改为 <code>const IMAGE_SIZE = 416</code> ，否则会出现诸如</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">{&quot;message&quot;: &quot;The size of tensor a (52) must match the size of tensor b (80) at non-singleton dimension 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Debug info for handle(s): debug_handles:{-1}, was not found.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Exception raised from infer_size_impl at /data/users/atalman/pytorch/aten/src/ATen/ExpandUtils.cpp:35 (most recent call first):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(no backtrace available)&quot;}</span><br></span></code></pre></div></div>
<p>或者</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">{&quot;message&quot;: &quot;shape &#x27;[1, 2, 60, 52, 52]&#x27; is invalid for input of size 768000&quot;}</span><br></span></code></pre></div></div>
<p>这样的错误（52x8=416 而 80x8=640），且 416 分辨率下测得 <code>detect: 150ms</code></p>
<p>发现主要耗时在 detect 给出了 25200 个结果让 NMS 中的 for 循环做后处理，所以可以想办法使用 topk 只让 NMS 处理前 <code>nMSLimit = 200</code> 个预测值最大的结果，比如在 <code>outputsToNMSPredictions</code> 函数定义中</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">-  const rows = prediction.shape[0];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+  const indices = prediction.topk(nMSLimit, {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+    dim: 0,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+    largest: true,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+    sorted: true,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+  })[1];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+  const rows = indices.shape[0];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   const numberOfClass = prediction.shape[1] - 5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   for (let i = 0; i &lt; rows; i++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-    const outputs = prediction[i].data();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+    const indiceScoreSorted = indices[i][4];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+    const outputs = prediction[indiceScoreSorted].data();</span><br></span></code></pre></div></div>
<p>以及</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> function nonMaxSuppression(boxes, limit, threshold) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+  // 之前已经用 prediction.topk 在 native 层排序过了，所以这里不再在 js 层排序了</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   // Do an argsort on the confidence scores, from high to low.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-  const newBoxes = boxes.sort((a, b) =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-    return a.score - b.score;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-  });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+  // const newBoxes = boxes.sort((a, b) =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+  //   return a.score - b.score;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+  // });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+  const newBoxes = boxes;</span><br></span></code></pre></div></div>
<p>此时测得</p>
<p>detect: 370ms
NMS: 140ms</p>
<p>总用时优化了 13 倍！</p>
<p>进一步测试可知 <code>outputsToNMSPredictions</code> 函数中的 for 循环里每 <code>prediction[indiceScoreSorted].data()</code> 一次就需耗时 1ms 左右，因此上面如果 <code>nMSLimit = 500</code> ，则就会测得 <code>NMS: 500ms</code> 左右，经分析还可以这样优化</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">-  const numberOfClass = prediction.shape[1] - 5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+  const predictionLength = prediction.shape[1];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+  const numberOfClass = predictionLength - 5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+  const indicesArray = indices.data();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+  const predictionsArray = prediction.data();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   for (let i = 0; i &lt; rows; i++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-    const indiceScoreSorted = indices[i][4];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-    const outputs = prediction[indiceScoreSorted].data();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+    const indiceScoreSorted = indicesArray[i * predictionLength + 4];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+    const predictionPoint = indiceScoreSorted * predictionLength;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     // Only consider an object detected if it has a confidence score of over predictionThreshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-    const score = outputs[4];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+    const score = predictionsArray[predictionPoint + 4];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     if (score &gt; predictionThreshold) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       // Find the detected objct calss with max score and get the classIndex</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-      let max = outputs[5];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+      let max = predictionsArray[predictionPoint + 5];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       let classIndex = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       for (let j = 0; j &lt; numberOfClass; j++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-        if (outputs[j + 5] &gt; max) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-          max = outputs[j + 5];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+        if (predictionsArray[predictionPoint + j + 5] &gt; max) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+          max = predictionsArray[predictionPoint + j + 5];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           classIndex = j;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       // Calulate the bound of the detected object bounding box</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-      const x = outputs[0];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-      const y = outputs[1];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-      const w = outputs[2];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-      const h = outputs[3];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+      const x = predictionsArray[predictionPoint];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+      const y = predictionsArray[predictionPoint + 1];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+      const w = predictionsArray[predictionPoint + 2];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+      const h = predictionsArray[predictionPoint + 3];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       const left = imgScaleX * (x - w / 2);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       const top = imgScaleY * (y - h / 2);</span><br></span></code></pre></div></div>
<p>此时测得</p>
<p>detect: 370ms
NMS: 20ms</p>
<p>但还达不到视频实时检测的总用时需求 33ms</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="react-native-pytorch-core-与-yolov7"><code>react-native-pytorch-core</code> 与 <code>yolov7</code><a href="#react-native-pytorch-core-与-yolov7" class="hash-link" aria-label="Direct link to react-native-pytorch-core-与-yolov7" title="Direct link to react-native-pytorch-core-与-yolov7" translate="no">​</a></h2>
<p>继续优化性能。</p>
<p>参考 <a href="https://github.com/flyskywhy/wrgb" target="_blank" rel="noopener noreferrer">wrgb dataset</a> 进行修改，</p>
<p>git clone <a href="https://github.com/WongKinYiu/yolov7" target="_blank" rel="noopener noreferrer">https://github.com/WongKinYiu/yolov7</a>
cd yolov7</p>
<h1>Uncomment coremltools onnx onnx-simplifier in requirements.txt to run export.py</h1>
<p>pip install -r requirements.txt</p>
<p>将 <code>yolov7/models/yolov7-tiny.yaml</code> 复制为 <code>datasets/wrgb/yolov7-tiny.yaml</code> 并把其中的 <code>nc: 80</code> 改为 <code>nc: 4</code></p>
<p>将 <code>datasets/wrgb/models/obj.yaml</code> 设为如下内容</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">train: ../datasets/wrgb/train.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">val: ../datasets/wrgb/train.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nc: 4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">names: [ &#x27;w&#x27;, &#x27;r&#x27;, &#x27;g&#x27;, &#x27;b&#x27;]</span><br></span></code></pre></div></div>
<p>To train:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    # Download `yolov7-tiny.pt` from &lt;https://github.com/WongKinYiu/yolov7/releases&gt; as `cfg/training/yolov7-tiny.pt`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rm ../datasets/wrgb/train.cache # If needed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    python train.py --epochs 55 --data ../datasets/wrgb/obj.yaml --cfg ../datasets/wrgb/yolov7-tiny.yaml --hyp data/hyp.scratch.tiny.yaml --weights cfg/training/yolov7-tiny.pt --img-size 416 --workers 4 --project runs/yolov7-tiny_wrgb --device cpu</span><br></span></code></pre></div></div>
<p>To detect:</p>
<p>python detect.py --weights runs/yolov7-tiny_wrgb/exp/weights/best.pt --img-size 416 --source SOME.jpg</p>
<p>To mobile optimized model exported to <code>runs/yolov7-tiny_wrgb/exp/weights/best.torchscript.ptl</code>:</p>
<p>python export.py --weights runs/yolov7-tiny_wrgb/exp/weights/best.pt --grid --img-size 416
cp runs/yolov7-tiny_wrgb/exp/weights/best.torchscript.ptl yolov7-tiny.ptl</p>
<p>得到 <code>yolov7-tiny.ptl</code> 。</p>
<p>测得</p>
<p>detect: 130ms</p>
<p>推理用时优化了 3 倍！（但识别率下降较多）</p>
<p>但还达不到视频实时检测的总用时需求 33ms</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="react-native-pytorch-core-与-yolov5-lite"><code>react-native-pytorch-core</code> 与 <code>YOLOv5-Lite</code><a href="#react-native-pytorch-core-与-yolov5-lite" class="hash-link" aria-label="Direct link to react-native-pytorch-core-与-yolov5-lite" title="Direct link to react-native-pytorch-core-与-yolov5-lite" translate="no">​</a></h2>
<p>看看是否能如 <a href="https://zhuanlan.zhihu.com/p/400545131" target="_blank" rel="noopener noreferrer">YOLOv5-Lite：更轻更快易于部署的YOLOv5</a> 所说那样训练出能在手机上实时识别的 <code>.ptl</code> 。</p>
<p>在通过 <a href="https://github.com/flyskywhy/YOLOv5-Lite/commit/bb07475" target="_blank" rel="noopener noreferrer">https://github.com/flyskywhy/YOLOv5-Lite/commit/bb07475</a> 提交点解决了推理 <code>model.forward</code> 返回的数据格式问题后，参考 <a href="https://github.com/flyskywhy/wrgb" target="_blank" rel="noopener noreferrer">wrgb dataset</a> 进行修改，</p>
<p>git clone <a href="https://github.com/flyskywhy/YOLOv5-Lite" target="_blank" rel="noopener noreferrer">https://github.com/flyskywhy/YOLOv5-Lite</a>
cd YOLOv5-Lite
pip install -r requirements.txt</p>
<p>将 <code>YOLOv5-Lite/models/v5Lite-e.yaml</code> 复制为 <code>datasets/wrgb/v5Lite-e.yaml</code> 并把其中的 <code>nc: 80</code> 改为 <code>nc: 4</code></p>
<p>将 <code>datasets/wrgb/models/obj.yaml</code> 设为如下内容</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">train: ../datasets/wrgb/train.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">val: ../datasets/wrgb/train.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nc: 4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">names: [ &#x27;w&#x27;, &#x27;r&#x27;, &#x27;g&#x27;, &#x27;b&#x27;]</span><br></span></code></pre></div></div>
<p>To train:</p>
<h1>Download <code>v5lite-e.pt</code> from <code>Download Link</code> in <code>YOLOv5-Lite/README.md</code> as <code>models/v5lite-e.pt</code></h1>
<p>rm ../datasets/wrgb/train.cache # If needed e.g. got <code>_pickle.UnpicklingError: STACK_GLOBAL requires str</code></p>
<p>python train.py --epochs 55 --data ../datasets/wrgb/obj.yaml --cfg ../datasets/wrgb/v5Lite-e.yaml --weights models/v5lite-e.pt --img-size 416 --workers 4 --batch-size 16 --project runs/yolov5Lite-e_wrgb --device cpu</p>
<p>To detect:</p>
<p>python detect.py --weights runs/yolov5Lite-e_wrgb/exp/weights/best.pt --img-size 416 --source SOME.jpg</p>
<p>To mobile optimized model exported to <code>runs/yolov5Lite-e_wrgb/exp/weights/best.ptl</code>:</p>
<p>python export.py --weights runs/yolov5Lite-e_wrgb/exp/weights/best.pt --grid --img-size 416
cp runs/yolov5Lite-e_wrgb/exp/weights/best.ptl YOLOv5Lite-e.ptl</p>
<p>得到 <code>YOLOv5Lite-e.ptl</code> 。</p>
<p>测得</p>
<p>detect: 110ms</p>
<p>接近但还达不到视频实时检测的总用时需求 33ms 以及 <a href="https://github.com/ppogg/YOLOv5-Lite" target="_blank" rel="noopener noreferrer">https://github.com/ppogg/YOLOv5-Lite</a> 官网描述在 NCNN 中的 320x320 情况下的 27ms ，估计要移植 NCNN 到 react-native 才有可能。</p>
<p>但在手机上测得当 <code>conf_thres</code> 设为 0.3 时， <code>YOLOv5Lite-e.ptl</code> 检测到 0 个而 <code>yolov7-tiny.ptl</code> 检测到 100 个目标，且  <code>yolov7-tiny.ptl</code> 很有几个打分在 0.8 以上的，只有当 <code>conf_thres</code> 设为 0.1 时 <code>YOLOv5Lite-e.ptl</code> 才检测到聊聊几个目标。</p>
<p>所以 <code>YOLOv5Lite-e.ptl</code> 看起来并不合适，或者可以再尝试下非官方的 <a href="https://github.com/bubbliiiing/yolov7-tiny-pytorch" target="_blank" rel="noopener noreferrer">https://github.com/bubbliiiing/yolov7-tiny-pytorch</a> 。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="react-native-pytorch-core-与-yolo-fastestv2"><code>react-native-pytorch-core</code> 与 <code>Yolo-FastestV2</code><a href="#react-native-pytorch-core-与-yolo-fastestv2" class="hash-link" aria-label="Direct link to react-native-pytorch-core-与-yolo-fastestv2" title="Direct link to react-native-pytorch-core-与-yolo-fastestv2" translate="no">​</a></h2>
<p>继续优化性能。</p>
<p>参考 <a href="https://github.com/flyskywhy/wrgb" target="_blank" rel="noopener noreferrer">wrgb dataset</a> 进行修改，</p>
<p>git clone <a href="https://github.com/flyskywhy/Yolo-FastestV2" target="_blank" rel="noopener noreferrer">https://github.com/flyskywhy/Yolo-FastestV2</a>
cd Yolo-FastestV2
pip install -r requirements.txt</p>
<p>参考 <code>Yolo-FastestV2/data/coco.data</code> 生成 <code>datasets/wrgb/obj-Yolo-FastestV2.data</code> 为如下内容</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[name]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">model_name=wrgb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[train-configure]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">epochs=55</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">steps=150,250</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">batch_size=16</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">subdivisions=1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">learning_rate=0.001</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[model-configure]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pre_weights=None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">classes=4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">width=416</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">height=416</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">anchor_num=3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">anchors=5.48,14.20, 13.54,14.93, 15.09,8.58, 16.81,16.89, 18.91,20.13, 23.56,24.22</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[data-configure]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">train=../datasets/wrgb/train-Yolo-FastestV2.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">val=../datasets/wrgb/train-Yolo-FastestV2.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">names=../datasets/wrgb/obj.names</span><br></span></code></pre></div></div>
<p>这里的 <code>anchors=</code> 来源自 <code>python genanchors.py --traintxt ../datasets/wrgb/train-Yolo-FastestV2.txt</code> 所生成的 <code>Yolo-FastestV2/anchors6.txt</code></p>
<p>这里的 <code>train-Yolo-FastestV2.txt</code> 复制自 <code>train.txt</code> 并将里面的相对路径替换为绝对路径。</p>
<p>To train:</p>
<p>python train.py --data ../datasets/wrgb/obj-Yolo-FastestV2.data
cp weights/best.torchscript.ptl Yolo-FastestV2.ptl</p>
<p>To detect:</p>
<p>python test.py --data ../datasets/wrgb/obj-Yolo-FastestV2.data --weights weights/wrgb-50-epoch-0.862199ap-model.pth --img SOME.jpg</p>
<p>得到 <code>Yolo-FastestV2.ptl</code> 。</p>
<p>测得</p>
<p>detect: 80ms</p>
<p><a href="https://github.com/dog-qiuqiu/Yolo-FastestV2" target="_blank" rel="noopener noreferrer">https://github.com/dog-qiuqiu/Yolo-FastestV2</a> 官网自称使用 NCNN 在麒麟 990 上可以达到 detect: 5ms</p>
<p>由于其推理 <code>model.forward</code> 返回的数据格式与 <code>yolov5</code> 和 <code>yolov7</code> 等不同导致无法直接使用在现有 APP 代码中，所以暂时无法得知打分情况在手机上的高低。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="yolo-代码大致流程">YOLO 代码大致流程<a href="#yolo-代码大致流程" class="hash-link" aria-label="Direct link to YOLO 代码大致流程" title="Direct link to YOLO 代码大致流程" translate="no">​</a></h2>
<p>在解决 <a href="https://github.com/flyskywhy/YOLOv5-Lite/commit/bb07475" target="_blank" rel="noopener noreferrer">https://github.com/flyskywhy/YOLOv5-Lite/commit/bb07475</a> 提交点所述问题时，通过加打印或删代码查看运行结果，大致了解了 YOLO 代码运行起来的关键节点，这里记录一下。</p>
<p>本文前面曾提及</p>
<p>await model.forward(formattedInputTensor)</p>
<p>检测目标或者说“推理”这个动作为什么叫做 forward 呢？</p>
<p>在 <code>models/yolo.py</code> 中的 forward_once 函数中可以看到</p>
<p>for m in self.model
...
x = m(x)  # run</p>
<p>该文件中 <code>class Detect(nn.Module)</code> 拥有一个 forward 函数，在 <code>models/common.py</code> 文件中可以看到各个 class 比如 DWConvblock 也都各自拥有 forward 函数，然后在 <code>models/v5Lite-e.yaml</code> 中的 module 那一列可以看到分布着 Detect 和 DWConvblock 等引用，所以推想，并通过加打印或删代码查看运行结果加以验证的方式，可知：</p>
<ul>
<li>某个 yaml 比如 <code>models/v5Lite-e.yaml</code> 被 <code>train.py</code> 训练出来的模型文件或者叫权重文件 <code>runs/yolov5Lite-e_wrgb/exp30/weights/best.pt</code> ，所对应的就是上面 forward_once 函数中的 <code>self.model</code>，体现着 <code>models/v5Lite-e.yaml</code> 文件中的内容</li>
<li>模型运行检测目标的功能或者叫推理，所对应的就是上面 forward_once 函数中的 <code>for m in self.model</code> 循环</li>
<li><code>models/v5Lite-e.yaml</code> 文件中的每一行或者叫网络中的每一层，所对应的就是上面 forward_once 函数中的 <code>for m in self.model</code> 中的 m</li>
<li>由 <code>models/v5Lite-e.yaml</code> 文件中的注释 <code># [from, number, module, args]</code> 可以看出，每一行由 4 部分组成，其中 from 代表是从前 n 层获得的输入，如 -1 表示从前一层获得输入， number 表示网络模块的数目，如 <code>[-1, 3, C3, [128]]</code> 表示含有 3 个 C3 模块， module 和 args 分别对应着比如 <code>class Detect</code> 和 Detect 的 <code>__init__</code> 函数中的参数</li>
<li>上面 forward_once 函数中运行到 <code>m(x)</code> 时，其实就是在运行 <code>models/v5Lite-e.yaml</code> 文件中某一行的 module 比如 DWConvblock 的 forward 函数</li>
<li>当运行完最后一个 m ，一般来说就是运行到 <code>models/v5Lite-e.yaml</code> 文件中的最后一行比如 Detect 那一行时，手机上的 <code>react-native-pytorch-core</code> 所对应的就是 <code>await model.forward(formattedInputTensor)</code> 执行完毕，电脑上的 <code>detect.py</code> 所对应的就是 <code>model(img, augment=opt.augment)</code> 执行完毕</li>
<li>例外地，如果在 forward_once 函数运行前预先通过代码的方式为 <code>self.model</code> 额外添加了最后一层，那么该层 m 就没有对应到 <code>models/v5Lite-e.yaml</code> 文件中的最后一行了，比如在 <code>detect.py</code> 文件中的 <code>model(img, augment=opt.augment)</code> 代码之前添加代码 <code>model.nms(True)</code> 的话，那么 <code>model(img, augment=opt.augment)</code> 所返回的就不是 Detect 的结果，而是再之后的 NMS 的结果</li>
<li>可惜 <code>react-native-pytorch-core</code> 只暴露了 forward 方法而没有暴露 nms 方法，无法进行 <code>await model.nms(true)</code> 操作，导致耗时的 NMS 操作要用 JS 代码重写一遍并更耗时地运行</li>
<li>可惜 <code>yolov7</code> 在 <code>export.py</code> 文件中的 <code>model(img)</code> 代码之前添加代码 <code>model.nms(True)</code> 的话，在 <code>export.py</code> 导出时会出错，导致耗时的 NMS 操作要用 JS 代码重写一遍并更耗时地运行（注， <code>YOLOv5-Lite</code> 的 <code>export.py</code> 添加 <code>model.nms(True)</code> 不会出错，但如前所述 <code>YOLOv5-Lite</code> 打分太低，我没兴趣再测这个了）</li>
<li>可惜 yaml 文件中最后再添加一行 NMS 的方法，在 <code>train.py</code> 训练时会出错，导致耗时的 NMS 操作要用 JS 代码重写一遍并更耗时地运行</li>
<li>可以考虑直接在 Detect 中调用 <code>utils/general.py</code> 的 <code>non_max_suppression</code> 函数或其它你自己业务的后处理操作，毕竟 <code>yolov7/models/yolo.py</code> 的 Detect 中可是堂而皇之地存在着 <code>self.include_nms</code> 这个 nms 字眼可以作为示例，只不过 <code>self.include_nms</code> 所调用的 <code>self.convert(z)</code> 中的 <code>box @= convert_matrix</code> 只不过是做了 <code>non_max_suppression</code> 函数中的 <code>xywh2xyxy(x[:, :4])</code> 操作而已，另外，这样做的时候需要考虑使用下面提到的 <code>torch.jit.script</code> 而不是大部分 YOLO 的 git 仓库中 <code>export.py</code> 所用的 <code>torch.jit.trace</code></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="exportpy-时需要注意的地方"><code>export.py</code> 时需要注意的地方<a href="#exportpy-时需要注意的地方" class="hash-link" aria-label="Direct link to exportpy-时需要注意的地方" title="Direct link to exportpy-时需要注意的地方" translate="no">​</a></h2>
<p>如<a href="https://blog.csdn.net/cxx654/article/details/115916275" target="_blank" rel="noopener noreferrer">Pytorch框架TorchScript模型转换方法</a>中所说，导出到 <code>.ptl</code> 时用到的 <code>torch.jit.trace</code> 是有一定限制的，因为 trace 方法不适用于 Module 中具有分支和循环结构的模型，可能需要自己想办法以 <code>torch.jit.script</code> 替代。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="优化思路">优化思路<a href="#优化思路" class="hash-link" aria-label="Direct link to 优化思路" title="Direct link to 优化思路" translate="no">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="更适合自己数据集的-anchor">更适合自己数据集的 anchor<a href="#更适合自己数据集的-anchor" class="hash-link" aria-label="Direct link to 更适合自己数据集的 anchor" title="Direct link to 更适合自己数据集的 anchor" translate="no">​</a></h3>
<p>参考<a href="https://zhuanlan.zhihu.com/p/112574936" target="_blank" rel="noopener noreferrer">新手也能彻底搞懂的目标检测Anchor是什么？怎么科学设置？</a>将 anchor box 即锚点框或叫先验框调节为适合自己项目数据集中目标物体的大小，以显著提升自己项目在目标检测时的速度。</p>
<p>或许直接使用 <a href="https://github.com/flyskywhy/Yolo-FastestV2" target="_blank" rel="noopener noreferrer">https://github.com/flyskywhy/Yolo-FastestV2</a> 中提供的 <code>genanchors.py</code> 来用 <code>python genanchors.py --traintxt ../datasets/wrgb/train-Yolo-FastestV2.txt</code> 自动生成 anchor 更合适。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="网上看到的一些优化概念">网上看到的一些优化概念<a href="#网上看到的一些优化概念" class="hash-link" aria-label="Direct link to 网上看到的一些优化概念" title="Direct link to 网上看到的一些优化概念" translate="no">​</a></h3>
<p>精度换计算/内存/通信：</p>
<ul>
<li>量化/用低精度计算：显而易见，如果你用Float16代替Float32，那么运行速度，需要的内存，需要的带宽基本上都可以直接砍一半</li>
<li>稀疏通信：精度换通信的一种做法：我们每次对梯度做all reduce的时候并不需要传所有梯度，只需要选择一部分（比如数值比较大）的梯度传输就好了</li>
<li>神经网络的各种剪枝：比如把很小的weight直接删掉，毕竟对最终结果没啥影响</li>
</ul>
<p>参考 <a href="https://openbayes.com/console/hyperai-tutorials/containers/2uN0r1tcWIj/overview" target="_blank" rel="noopener noreferrer">https://openbayes.com/console/hyperai-tutorials/containers/2uN0r1tcWIj/overview</a> 进行 int8 quantization 量化？</p>
<p>参考阅读：</p>
<ul>
<li><a href="https://mp.weixin.qq.com/s/IBZLLz0GV6E3EOeiJTMtjw" target="_blank" rel="noopener noreferrer">YOLOv5超详细的入门级教程（训练篇）——训练自己的数据集</a></li>
<li><a href="https://mp.weixin.qq.com/s/QI_2AICgobdTvOktnL_UCg" target="_blank" rel="noopener noreferrer">Pytorch 数据流中常见Trick总结</a></li>
<li><a href="https://mp.weixin.qq.com/s/aVJQqeZyw0ljsBq1kElt_w" target="_blank" rel="noopener noreferrer">YOLO系列梳理（一）YOLOv1-YOLOv3</a></li>
<li><a href="https://blog.51cto.com/u_15953612/6241978" target="_blank" rel="noopener noreferrer">YOLOv5：yolov5s.yaml配置文件解读</a></li>
<li><a href="https://blog.51cto.com/u_15953612/6316713" target="_blank" rel="noopener noreferrer">YOLOv5：解读yolo.py</a></li>
<li><a href="https://blog.csdn.net/weixin_50006912/article/details/129122501" target="_blank" rel="noopener noreferrer">Yolov5添加检测层，四层结构对小目标、密集场景更友好</a></li>
<li><a href="https://www.ruanyifeng.com/blog/2015/09/matrix-multiplication.html" target="_blank" rel="noopener noreferrer">理解矩阵乘法</a></li>
<li><a href="https://github.com/bubbliiiing/yolov4-tiny-pytorch/blob/master/%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E6%B1%87%E6%80%BB.md" target="_blank" rel="noopener noreferrer">常见问题汇总</a></li>
</ul></div></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/g/docs/i主观的体验方式/t快乐的体验/电信/Tool/配置管理/Git/将已有的Markdown文档Git仓库自动转为网页并托管为网站"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">将已有的Markdown文档Git仓库自动转为网页并托管为网站</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/g/docs/i主观的体验方式/t快乐的体验/电信/Video/QuickCut使用详解"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">QuickCut使用详解</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#深度学习现状" class="table-of-contents__link toc-highlight">深度学习现状</a></li><li><a href="#react-native-pytorch-core-与-yolov5" class="table-of-contents__link toc-highlight"><code>react-native-pytorch-core</code> 与 <code>yolov5</code></a></li><li><a href="#react-native-pytorch-core-与-yolov7" class="table-of-contents__link toc-highlight"><code>react-native-pytorch-core</code> 与 <code>yolov7</code></a></li><li><a href="#react-native-pytorch-core-与-yolov5-lite" class="table-of-contents__link toc-highlight"><code>react-native-pytorch-core</code> 与 <code>YOLOv5-Lite</code></a></li><li><a href="#react-native-pytorch-core-与-yolo-fastestv2" class="table-of-contents__link toc-highlight"><code>react-native-pytorch-core</code> 与 <code>Yolo-FastestV2</code></a></li><li><a href="#yolo-代码大致流程" class="table-of-contents__link toc-highlight">YOLO 代码大致流程</a></li><li><a href="#exportpy-时需要注意的地方" class="table-of-contents__link toc-highlight"><code>export.py</code> 时需要注意的地方</a></li><li><a href="#优化思路" class="table-of-contents__link toc-highlight">优化思路</a><ul><li><a href="#更适合自己数据集的-anchor" class="table-of-contents__link toc-highlight">更适合自己数据集的 anchor</a></li><li><a href="#网上看到的一些优化概念" class="table-of-contents__link toc-highlight">网上看到的一些优化概念</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/g/docs">Docs</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://x.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">X<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/g/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/flyskywhy/g" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>