<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-i主观的体验方式/t快乐的体验/电信/Tool/配置管理/Git/GitLab使用详解" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.1">
<title data-rh="true">GitLab使用详解 | My Site</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://flyskywhy.github.io/g/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://flyskywhy.github.io/g/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://flyskywhy.github.io/g/docs/i主观的体验方式/t快乐的体验/电信/Tool/配置管理/Git/GitLab使用详解"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="GitLab使用详解 | My Site"><meta data-rh="true" name="description" content="Li Zheng flyskywhy@gmail.com"><meta data-rh="true" property="og:description" content="Li Zheng flyskywhy@gmail.com"><link data-rh="true" rel="icon" href="/g/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://flyskywhy.github.io/g/docs/i主观的体验方式/t快乐的体验/电信/Tool/配置管理/Git/GitLab使用详解"><link data-rh="true" rel="alternate" href="https://flyskywhy.github.io/g/docs/i主观的体验方式/t快乐的体验/电信/Tool/配置管理/Git/GitLab使用详解" hreflang="en"><link data-rh="true" rel="alternate" href="https://flyskywhy.github.io/g/docs/i主观的体验方式/t快乐的体验/电信/Tool/配置管理/Git/GitLab使用详解" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"GitLab使用详解","item":"https://flyskywhy.github.io/g/docs/i主观的体验方式/t快乐的体验/电信/Tool/配置管理/Git/GitLab使用详解"}]}</script><link rel="alternate" type="application/rss+xml" href="/g/blog/rss.xml" title="My Site RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/g/blog/atom.xml" title="My Site Atom Feed"><link rel="stylesheet" href="/g/assets/css/styles.faf98e1c.css">
<script src="/g/assets/js/runtime~main.e8914f07.js" defer="defer"></script>
<script src="/g/assets/js/main.fd282c03.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/g/img/logo.png"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/g/"><div class="navbar__logo"><img src="/g/img/logo.png" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/g/img/logo.png" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">My Site</b></a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/g/docs/">文档</a><a href="https://github.com/flyskywhy/g" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/g/docs/"><span title="README" class="linkLabel_WmDU">README</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/g/docs/i主观的体验方式/i悲伤的体验/中医/中药的“威力”"><span title="i主观的体验方式" class="categoryLinkLabel_W154">i主观的体验方式</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/g/docs/i主观的体验方式/i悲伤的体验/中医/中药的“威力”"><span title="i悲伤的体验" class="categoryLinkLabel_W154">i悲伤的体验</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/商/Pm/小团队项目管理软件的的选择"><span title="t快乐的体验" class="categoryLinkLabel_W154">t快乐的体验</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/商/Pm/小团队项目管理软件的的选择"><span title="商" class="categoryLinkLabel_W154">商</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/处世/如何做好人生最重要的事——选择"><span title="处世" class="categoryLinkLabel_W154">处世</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/手机/手机投屏到手机的方法"><span title="手机" class="categoryLinkLabel_W154">手机</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/政/atLJJ"><span title="政" class="categoryLinkLabel_W154">政</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/电信/Cpu/Riscv/LicheeRV使用详解"><span title="电信" class="categoryLinkLabel_W154">电信</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-4 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/电信/Cpu/Riscv/LicheeRV使用详解"><span title="Cpu" class="categoryLinkLabel_W154">Cpu</span></a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/电信/Education/"><span title="README" class="linkLabel_WmDU">README</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-4 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/电信/Fs/Ipfs/Ipfs使用详解"><span title="Fs" class="categoryLinkLabel_W154">Fs</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-4 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/电信/Net/Vpn/VPN路由设置详解"><span title="Net" class="categoryLinkLabel_W154">Net</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-4 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/电信/Os/AliOsThings/BoneEngine使用详解"><span title="Os" class="categoryLinkLabel_W154">Os</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-4 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/电信/Test/Firebase使用详解"><span title="Test" class="categoryLinkLabel_W154">Test</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-4 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/电信/Tool/Probe/Fs2/mips仿真器gdb调试方法"><span title="Tool" class="categoryLinkLabel_W154">Tool</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-5 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/电信/Tool/Probe/Fs2/mips仿真器gdb调试方法"><span title="Probe" class="categoryLinkLabel_W154">Probe</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-5 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/电信/Tool/文件管理/Syncthing/Syncthing在网络化测试机项目中的应用方式"><span title="文件管理" class="categoryLinkLabel_W154">文件管理</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-5 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/电信/Tool/文档编辑/Maqetta/Maqetta使用详解"><span title="文档编辑" class="categoryLinkLabel_W154">文档编辑</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-5 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/电信/Tool/编程语言/C/C语言编码规范"><span title="编程语言" class="categoryLinkLabel_W154">编程语言</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-5 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/电信/Tool/翻墙/Clash使用详解"><span title="翻墙" class="categoryLinkLabel_W154">翻墙</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-5 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/电信/Tool/配置管理/Git/GitLab使用详解"><span title="配置管理" class="categoryLinkLabel_W154">配置管理</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-6 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/电信/Tool/配置管理/Git/GitLab使用详解"><span title="Git" class="categoryLinkLabel_W154">Git</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-7 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/电信/Tool/配置管理/Git/GitLab使用详解"><span title="GitLab使用详解" class="linkLabel_WmDU">GitLab使用详解</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-7 menu__list-item"><a class="menu__link" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/电信/Tool/配置管理/Git/GitLab自动部署nodejs应用到阿里云Kubernetes集群中"><span title="GitLab自动部署nodejs应用到阿里云Kubernetes集群中" class="linkLabel_WmDU">GitLab自动部署nodejs应用到阿里云Kubernetes集群中</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-7 menu__list-item"><a class="menu__link" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/电信/Tool/配置管理/Git/Git最简培训"><span title="Git最简培训" class="linkLabel_WmDU">Git最简培训</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-7 menu__list-item"><a class="menu__link" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/电信/Tool/配置管理/Git/msysgit使用详解"><span title="msysgit使用详解" class="linkLabel_WmDU">msysgit使用详解</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-7 menu__list-item"><a class="menu__link" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/电信/Tool/配置管理/Git/《不拉马的士兵》与git仓库管理方式"><span title="《不拉马的士兵》与git仓库管理方式" class="linkLabel_WmDU">《不拉马的士兵》与git仓库管理方式</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-7 menu__list-item"><a class="menu__link" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/电信/Tool/配置管理/Git/制作git中心仓库的方法"><span title="制作git中心仓库的方法" class="linkLabel_WmDU">制作git中心仓库的方法</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-7 menu__list-item"><a class="menu__link" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/电信/Tool/配置管理/Git/前端CDN网址跨域访问后端nodejs应用负载均衡网址的方法"><span title="前端CDN网址跨域访问后端nodejs应用负载均衡网址的方法" class="linkLabel_WmDU">前端CDN网址跨域访问后端nodejs应用负载均衡网址的方法</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-7 menu__list-item"><a class="menu__link" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/电信/Tool/配置管理/Git/将已有的Markdown文档Git仓库自动转为网页并托管为网站"><span title="将已有的Markdown文档Git仓库自动转为网页并托管为网站" class="linkLabel_WmDU">将已有的Markdown文档Git仓库自动转为网页并托管为网站</span></a></li></ul></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-4 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/电信/Video/PyTorch使用详解"><span title="Video" class="categoryLinkLabel_W154">Video</span></a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/画/Ai/fastsdcpu使用详解"><span title="画" class="categoryLinkLabel_W154">画</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/行/杭州老和山游步道、杭州乐园2日游"><span title="行" class="categoryLinkLabel_W154">行</span></a></div></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/g/docs/t客观的存在原理/i人体内部的存在/t肉体/现代医学的哲学理念"><span title="t客观的存在原理" class="categoryLinkLabel_W154">t客观的存在原理</span></a></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/g/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">i主观的体验方式</span></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">t快乐的体验</span></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">电信</span></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Tool</span></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">配置管理</span></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Git</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">GitLab使用详解</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><p>Li Zheng <a href="mailto:flyskywhy@gmail.com" target="_blank" rel="noopener noreferrer">flyskywhy@gmail.com</a></p>
<header><h1>安装</h1></header>
<p>按照 <a href="https://about.gitlab.com/downloads/" target="_blank" rel="noopener noreferrer">https://about.gitlab.com/downloads/</a> 中的 <a href="https://mirror.tuna.tsinghua.edu.cn/help/gitlab-ce/" target="_blank" rel="noopener noreferrer">https://mirror.tuna.tsinghua.edu.cn/help/gitlab-ce/</a> 所说进行安装。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="首次启动">首次启动<a href="#首次启动" class="hash-link" aria-label="Direct link to 首次启动" title="Direct link to 首次启动" translate="no">​</a></h2>
<p>使用 <code>sudo gitlab-ctl reconfigure</code> 来启动，首次启动时会打印出自动生成的各种配置文件的内容，可将之复制保存下来以备后用。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="解决-80-端口被占问题">解决 80 端口被占问题<a href="#解决-80-端口被占问题" class="hash-link" aria-label="Direct link to 解决 80 端口被占问题" title="Direct link to 解决 80 端口被占问题" translate="no">​</a></h2>
<p>如果用浏览器打开 gitlab-ce 安装所在的主机的网页比如 192.x.x.7 时发现没有进入 gitlab 相关的正常或错误的界面，而是进入了其它页面，则说明之前 80 端口早已被占用，此时除了与其它程序共享 80 端口外，还可以将 gitlab 的端口进行调整。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="与其它程序共享-80-端口">与其它程序共享 80 端口<a href="#与其它程序共享-80-端口" class="hash-link" aria-label="Direct link to 与其它程序共享 80 端口" title="Direct link to 与其它程序共享 80 端口" translate="no">​</a></h3>
<p>gitlab 用的 web 服务程序是 nginx ，如果占用 80 端口的其它程序也是 nginx 的，则可以共享之。</p>
<p>将原先的内含 <code>listen 80</code> 语句的比如 <code>/etc/nginx/sites-enabled/default</code> 文件移动为 <code>/etc/nginx/conf.d/default</code> ，然后将 <code>/etc/gitlab/gitlab.rb</code> 中的 <code># nginx[&#x27;custom_nginx_config&#x27;] = &quot;include /etc/nginx/conf.d/example.conf;&quot;</code> 修改为 <code>nginx[&#x27;custom_nginx_config&#x27;] = &quot;include /etc/nginx/conf.d/default;&quot;</code></p>
<p><code>/etc/gitlab/gitlab.rb</code> 中默认用 HOSTNAME 来作为外部链接</p>
<p>external_url &#x27;<a href="http://SomeHostName" target="_blank" rel="noopener noreferrer">http://SomeHostName</a>&#x27;</p>
<p>这个外部链接将被用作比如用户注册确认邮件中的确认地址等 gitlab 基础功能，所以需要将其设置为浏览器可以访问到的地址，比如：</p>
<p>external_url &#x27;<a href="http://gitlab.your-company.com" target="_blank" rel="noopener noreferrer">http://gitlab.your-company.com</a>&#x27;</p>
<p>还需要在 DNS 提供商那里或是用户电脑操作系统的 hosts 文件中，将 <code>www.your-company.com</code> 和 <code>gitlab.your-company.com</code> 都指向同一个 IP 地址（ gitlab-ce 安装所在的主机）。</p>
<p>最后</p>
<p>sudo service nginx restart
sudo gitlab-ctl reconfigure</p>
<p>即可。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="将-gitlab-的-80-端口进行调整">将 gitlab 的 80 端口进行调整<a href="#将-gitlab-的-80-端口进行调整" class="hash-link" aria-label="Direct link to 将 gitlab 的 80 端口进行调整" title="Direct link to 将 gitlab 的 80 端口进行调整" translate="no">​</a></h3>
<p>如果占用 80 端口的其它程序不是 nginx ，则只能调整 gitlab 的端口了。</p>
<p>从上面首次启动 <code>sudo gitlab-ctl reconfigure</code> 所打印出来的信息可以看到，有个 gitlab-http.conf 文件中含有</p>
<p>listen *:80</p>
<p>这样的信息，然后使用 <code>grep gitlab-http.conf /opt/gitlab/* -rsi</code> 搜索一下会看到一个链接 <a href="https://gitlab.com/gitlab-org/omnibus-gitlab/blob/master/files/gitlab-cookbooks/gitlab/templates/default/nginx-gitlab-http.conf.erb" target="_blank" rel="noopener noreferrer">https://gitlab.com/gitlab-org/omnibus-gitlab/blob/master/files/gitlab-cookbooks/gitlab/templates/default/nginx-gitlab-http.conf.erb</a>，进去就会发现</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    listen &lt;%= listen_address %&gt;:&lt;%= @listen_port %&gt;</span><br></span></code></pre></div></div>
<p>所以我们需要修改 <code>/etc/gitlab/gitlab.rb</code> 中的 <code>listen_port</code> ，然后实际上是把</p>
<h1>nginx[&#x27;listen_port&#x27;] = nil</h1>
<p>修改为比如</p>
<p>nginx[&#x27;listen_port&#x27;] = 8788</p>
<p><code>/etc/gitlab/gitlab.rb</code> 中默认用 HOSTNAME 来作为外部链接</p>
<p>external_url &#x27;<a href="http://SomeHostName" target="_blank" rel="noopener noreferrer">http://SomeHostName</a>&#x27;</p>
<p>这个外部链接将被用作比如用户注册确认邮件中的确认地址等 gitlab 基础功能，所以需要将其设置为浏览器可以访问到的地址，比如：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    external_url &#x27;http://192.x.x.7:8788&#x27;</span><br></span></code></pre></div></div>
<p>最后 <code>sudo gitlab-ctl reconfigure</code> 即可。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="解决-8080-端口被占问题">解决 8080 端口被占问题<a href="#解决-8080-端口被占问题" class="hash-link" aria-label="Direct link to 解决 8080 端口被占问题" title="Direct link to 解决 8080 端口被占问题" translate="no">​</a></h2>
<p>如果用浏览器打开 gitlab-ce 安装所在的主机的网页比如 192.x.x.7:8788 时发现所打开的 GitLab 网页出现 <code>Whoops, GitLab is taking too much time to respond</code> 的提示，一般是因为 8080 被占用了。</p>
<p>这个就比较简单了，把 <code>/etc/gitlab/gitlab.rb</code> 中搜索到的 <code>8080</code> 修改为比如 <code>8787</code> ，最后 <code>sudo gitlab-ctl reconfigure</code> 即可。</p>
<h1>帐号</h1>
<p>首次用浏览器打开 gitlab-ce 安装所在的主机的网页比如 192.x.x.7:8788 时，会进入一个修改密码的页面，此时修改的是 gitlab-ce 的 root 帐号的密码。然后就可以进行正常的用户注册登录等操作了。</p>
<h1>邮件</h1>
<p>在一些环节比如用户注册时是需要发邮件给用户的， gitlab-ce 一开始默认是使用 <code>/usr/sbin/sendmail</code> 来发送邮件，如果还不存在 sendmail 的话可安装 <code>sudo apt-get install postfix</code> 并配置好，或者是按照 <a href="https://docs.gitlab.com/omnibus/settings/smtp.html" target="_blank" rel="noopener noreferrer">https://docs.gitlab.com/omnibus/settings/smtp.html</a> 来修改 <code>/etc/gitlab/gitlab.rb</code> 并 <code>sudo gitlab-ctl reconfigure</code> 使其生效。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="邮件发送测试">邮件发送测试<a href="#邮件发送测试" class="hash-link" aria-label="Direct link to 邮件发送测试" title="Direct link to 邮件发送测试" translate="no">​</a></h2>
<p>邮件配置后需要测试是否配置正确。运行如下命令</p>
<p>gitlab-rails console</p>
<p>稍等二十秒左右启动控制台后，在其中使用如下命令来测试邮件是否发送成功</p>
<p>Notify.test_email(&#x27;<a href="mailto:destination_email@address.com" target="_blank" rel="noopener noreferrer">destination_email@address.com</a>&#x27;, &#x27;Message Subject&#x27;, &#x27;Message Body&#x27;).deliver_now</p>
<h1>安全</h1>
<p>作为内部使用的 Git 仓库，安全是非常重要的，因此要及时用 root 账户进入比如 <code>http://192.x.x.7:8788/admin/application_settings</code> 进行分支保护程度、仓库可见程度、用户注册是否发送确认邮件等等默认全局设置。后续特定 Project 的分支保护程度和仓库可见程度可分别到 <code>Settings &gt; Repository &gt; Protected Branches</code> 和 <code> Settings &gt; General</code> 中去设置，比如纯文档类的仓库，就没必要进行 Merge Request 了，每个开发人员无需 Fork 到自己名下，而是直接在原仓库的 gitlab 网页上修改，这种情况下只要到 <code>Settings &gt; Repository &gt; Protected Branches</code> 中 <code>Unprotect</code> ，并且在 Group 的 <code>Members</code> 或 Project 的 <code>Settings &gt; Members</code> 中显式地将允许修改的开发人员至少添加为 Developer 即可。</p>
<h1>备份恢复迁移</h1>
<p>参考了 <a href="http://www.cnblogs.com/lidong94/p/7161717.html" target="_blank" rel="noopener noreferrer">Gitlab配置、备份、升级、迁移</a> 一文，备份方法是：</p>
<p>sudo gitlab-rake gitlab:backup<!-- -->:create</p>
<p>其会在 <code>/var/opt/gitlab/backups</code> 目录下创建一个名称类似为 <code>1516244351_2018_01_18_9.3.2_gitlab_backup.tar</code> 的压缩包。</p>
<p>恢复方法例如：</p>
<p>sudo gitlab-rake gitlab:backup<!-- -->:restore<!-- --> BACKUP=1516244351</p>
<p>迁移如同备份与恢复的步骤一样，只需要将老服务器 <code>/var/opt/gitlab/backups</code> 目录下的备份文件复制到新服务器上的 <code>/var/opt/gitlab/backups</code> 即可，但是需要注意的是新服务器上的 gitlab 的版本必须与创建备份时的 gitlab 版本号相同。</p>
<h1>升级</h1>
<p>gitlab 公司每个月 22 日都会发布升级包，参考 <a href="https://gitlab.com/gitlab-org/omnibus-gitlab/blob/master/doc/update/README.md" target="_blank" rel="noopener noreferrer">Updating GitLab via omnibus-gitlab</a> 和 <a href="https://docs.gitlab.com/ce/update/README.html#upgrading-without-downtime" target="_blank" rel="noopener noreferrer">Upgrading without downtime</a> ，只要安装 gitlab 时用的是 PostgreSQL ，然后每次只升级一个中间的 minor 版本号，比如从 gitlab 9.3.2 升级到 9.4.0 或是 9.4.7 之类的，而不是直接升级到 9.5.0，那么我们的 gitlab 就可以做到无需关停（当然在运行 <code>gitlab-ctl reconfigure</code> 的几十秒内会无法访问）就能升级。</p>
<p>在 <a href="https://packages.gitlab.com/gitlab/gitlab-ce" target="_blank" rel="noopener noreferrer">APT/YUM repository for GitLab Community Edition packages</a> 上确认自己想升级的版本号，比如 9.4.0-ce.0 ，然后具体升级流程如下：</p>
<p>sudo apt-get update
sudo gitlab-rake gitlab:backup<!-- -->:create<!-- -->    # 进行备份操作，非必需
sudo touch /etc/gitlab/skip-auto-migrations
sudo apt-get install gitlab-ce=9.4.0-ce.0
sudo SKIP_POST_DEPLOYMENT_MIGRATIONS=true gitlab-ctl reconfigure
sudo gitlab-rake db<!-- -->:migrate</p>
<h1>配置</h1>
<p>gitlab-ce 内含了 redis 、 nginx 等等各种第三方软件包（被安装在 <code>/opt/gitlab/embedded/</code> ），可以按需在 <code>/etc/gitlab/gitlab.rb</code> 中进行配置，详见 <a href="https://docs.gitlab.com/omnibus/settings/configuration.html" target="_blank" rel="noopener noreferrer">https://docs.gitlab.com/omnibus/settings/configuration.html</a> 。</p>
<p>由 <a href="https://docs.gitlab.com/omnibus/package-information/README.html#checking-for-newer-configuration-options-on-upgrade" target="_blank" rel="noopener noreferrer">Checking for newer configuration options on upgrade</a> 可知，在首次安装 gitlab 时会自动生成 <code>/etc/gitlab/gitlab.rb</code> 文件，后续升级 gitlab 时则不会自动修改该文件，这是为了避免升级过程不小心覆盖用户配置。这样也是能正常运行升级后的 gitlab 的。可以通过 <code>sudo gitlab-ctl diff-config</code> 来查看自己的配置与原始版本 <code>/opt/gitlab/etc/gitlab.rb.template</code> 的区别，如果追求完美的，可以将两者手工合并为新的 <code>/etc/gitlab/gitlab.rb</code> 。</p>
<h1>启停</h1>
<p>每次修改配置后，需要 <code>sudo gitlab-ctl reconfigure</code> 来启动。
如果想临时关闭（包括内含的 nginx 等等）的，则 <code>sudo gitlab-ctl stop</code> 来关闭所有或是比如 <code>sudo gitlab-ctl stop nginx</code> 来关闭其中一个。</p>
<h1>mount</h1>
<p>对许多 Linux 系统来说，存放了用户数据的 /var/opt/gitlab/ 所在的 /var 是属于 / 分区的，一般而言 / 分区不会特别大，因此不停增长中的用户数据还是放在别的分区甚至别的电脑上更合适。一般使用 mount 来做到这一点。为保险起见，当使用 mount 时，可以在 <code>/etc/gitlab/gitlab.rb</code> 添加如下语句：</p>
<h1>wait for /var/opt/gitlab to be mounted</h1>
<p>high_availability[&#x27;mountpoint&#x27;] = &#x27;/var/opt/gitlab&#x27;</p>
<p>当然仅仅把 Git 仓库 <code>/var/opt/gitlab/git-data</code> 进行 mount 也是可以的。</p>
<p>最后 <code>sudo gitlab-ctl reconfigure</code> 即可。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="mount-nfs">mount nfs<a href="#mount-nfs" class="hash-link" aria-label="Direct link to mount nfs" title="Direct link to mount nfs" translate="no">​</a></h2>
<p>如果是远程 mount 的，经试验， sshfs 挂载的文件（夹）的权限无法满足 gitlab 的需求，所以只能用 nfs 。</p>
<p>在<strong>本地</strong>停止 gitlab-ce 的运行</p>
<p>sudo gitlab-ctl stop</p>
<p>在<strong>本地</strong>把本地已经存在的用户数据复制到远程去</p>
<p>sudo rsync -avuz /var/opt/gitlab/ -e ssh root@192.x.x.8:/pub/gitlab/</p>
<p>如果远程也存在一个叫 git 的账户的，上面的 rsync 操作会把本地上属于 git 用户/组 的文件（夹）自动转换成远程的 git 用户/组，因此还需在<strong>远程</strong>上执行如下操作以将它们再转换回本地 gitlab 所创建的 git 的 id 号 998 ：</p>
<p>sudo find /pub/gitlab/ -group git -exec chgrp -h 998 <!-- --> ;
sudo find /pub/gitlab/ -user git -exec chown -h 998 <!-- --> ;</p>
<p>在<strong>远程</strong>安装 nfs 服务端</p>
<p>sudo apt-get install nfs-kernel-server</p>
<p>在<strong>远程</strong>配置 nfs 服务端</p>
<p>sudo vi /etc/exports</p>
<p>填入如下内容</p>
<p>/pub/gitlab *(rw,no_root_squash,sync,no_wdelay)</p>
<p>在<strong>远程</strong>重启 nfs 服务端</p>
<p>sudo /etc/init.d/nfs restart</p>
<p>在<strong>本地</strong>安装 nfs 客户端</p>
<p>sudo apt install nfs-common</p>
<p>在<strong>本地</strong> mount 远程的用户数据</p>
<p>sudo mount -t nfs 192.x.x.8:/pub/gitlab /var/opt/gitlab</p>
<p>注：此时如果提示说 <code>mount.nfs: access denied by server while mounting 192.x.x.8:/pub/gitlab</code> ，则参考 <a href="https://blog.51cto.com/ydw1118/1728023" target="_blank" rel="noopener noreferrer">远程挂载NFS时mount.nfs: access denied by server while mounting 一个解决办法</a> 中所说，需要在 nfs 服务端的 <code>/etc/exports</code> 中 no_wdelay 后面再添加一个 insecure 选项。</p>
<p>在<strong>本地</strong>启动 gitlab-ce 的运行</p>
<p>sudo gitlab-ctl start</p>
<p>估计是远程 mount 的关系，此次 <code>sudo gitlab-ctl start</code> 后需要在浏览器上等待较长的二十秒钟左右才能自动结束 <code>Whoops, GitLab is taking too much time to respond</code> 的提示，而不要误以为是前面碰到的 8080 端口被占问题。</p>
<h1>关停帐号</h1>
<p>用 root 帐号可以关停用户帐号。有三种关停方式： <code>Block user</code> 、 <code>Remove user</code> 、 <code>Remove user and contributions</code> ，需要注意的是，记录在 PostgreSQL 中的 Snippets 会在后两种情况下消失。</p>
<h1>持续集成 CI</h1>
<p>让 gitlab 能够在新 commit （网页上直接修改文件内容而形成的 commit） 或 push 的事件时自动触发持续集成动作，有两个前提条件：将持续集成的具体动作比如“测试”、“部署”等 job 写在 Project 根目录中的 <code>.gitlab-ci.yml</code> 文件里；在 Project 的 gitlab 网页里配置好在另外一台服务器中运行的 Runner 以便让 Runner 去运行这些 job 。</p>
<p>如果在 commit 的注释中包含 <code>[ci skip]</code> 或 <code>[skip ci]</code> ，无论大小写，则该 commit 不会触发 CI 。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="创建-gitlab-ciyml-文件">创建 .gitlab-ci.yml 文件<a href="#创建-gitlab-ciyml-文件" class="hash-link" aria-label="Direct link to 创建 .gitlab-ci.yml 文件" title="Direct link to 创建 .gitlab-ci.yml 文件" translate="no">​</a></h2>
<p>参照 <a href="https://docs.gitlab.com/ce/ci/quick_start/README.html" target="_blank" rel="noopener noreferrer">Getting started with GitLab CI</a> 和 <a href="https://docs.gitlab.com/ce/ci/yaml/README.html" target="_blank" rel="noopener noreferrer">Configuration of your jobs with .gitlab-ci.yml</a> 两篇文章，简单来说，除了 stages 、 cache 等关键字外，其它顶行书写的都是 job 。如果 job 中没有描述 stage 字段的，则这个 job 的 stage 默认为 test 。如果存在有 stages 的比如：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">stages:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - build</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - deploy</span><br></span></code></pre></div></div>
<p>则首先并行执行完所有 stage 为 build 的 job ，如果这些 job 都成功了，就并行执行所有 stage 为 test 的 job ，以此类推。</p>
<p>job 中必须至少含有一个关键字 script 用来执行该 job 的动作，比如：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">test_gitlab_ci:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  script:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - npm install</span><br></span></code></pre></div></div>
<p>为了避免经常让 npm 重新下载那些 node_modules ，可以添加 cache 关键字，比如：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cache:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  paths:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - node_modules/</span><br></span></code></pre></div></div>
<p>在 gitlab 的 Project 页面上有 <code>Set up CI</code> 按钮可以方便地直接跳转到 Repository 页面并且自动点击了 <code>+</code> 按钮、自动选择了 <code>.gitlab-ci.yml</code> 这个 Template ，只需要再人工选择一下 <code>Apply a GitLab CI Yaml template</code> 并进行修改即可。</p>
<p><code>.gitlab-ci.yml</code> 的语法是否书写正确， 可以在 <a href="http://gitlab.your-company.com/ci/lint" target="_blank" rel="noopener noreferrer">http://gitlab.your-company.com/ci/lint</a> 中进行验证，而不用等到 Runner 报来错误再去修改。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="下载-artifacts">下载 artifacts<a href="#下载-artifacts" class="hash-link" aria-label="Direct link to 下载 artifacts" title="Direct link to 下载 artifacts" translate="no">​</a></h3>
<p>job 中的 artifacts 关键字除了用于在 stages 之间传递中间产物之外，也可以被从 gitlab 网页上下载，这倒是方便了最终产物比如 <code>.apk</code> 文件的下载，详见 <a href="https://docs.gitlab.com/ce/user/project/pipelines/job_artifacts.html" target="_blank" rel="noopener noreferrer">Introduction to job artifacts</a> 。注意，如果使用了 artifacts 关键字，则要记得在里面用上 expire_in 关键字比如 <code>expire_in: 1 week</code> 以免 artifacts 一直被保存在 gitlab 的用户数据里而占用越来越多的硬盘空间。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="配置-runner">配置 Runner<a href="#配置-runner" class="hash-link" aria-label="Direct link to 配置 Runner" title="Direct link to 配置 Runner" translate="no">​</a></h2>
<p>Runner 最好是安装在与 Gitlab 不同的服务器上，因为 Runner 会消耗大量内存资源，而 Gitlab 如果没有足够内存的话会很卡顿。</p>
<p>Runner 分为两种：一个或多个 Project 特定使用的 specific Runner 以及 任何 Project 都能使用的 shared Runner 。</p>
<p>配置 Runner 时会用到 registration token ， specific Runner 的 token 是从 Project 的 <code>Settings ➔ Pipelines </code> 页面上获取的， shared Runner 的 token 是从 root 账户的 admin/runners 页面上获取的。</p>
<p>按照 <a href="http://docs.gitlab.com/runner/install/" target="_blank" rel="noopener noreferrer">Install GitLab Runner</a> 安装好 Runner ，然后在安装好 Runner 的服务器上进行配置，这里参考 <a href="http://docs.gitlab.com/runner/register/index.html" target="_blank" rel="noopener noreferrer">Registering Runners</a> 以 Linux 为例描述一下配置过程：</p>
<p>sudo gitlab-runner register</p>
<p>Please enter the gitlab-ci coordinator URL (e.g. <a href="https://gitlab.com" target="_blank" rel="noopener noreferrer">https://gitlab.com</a> ):</p>
<p><a href="http://gitlab.your-company.com" target="_blank" rel="noopener noreferrer">http://gitlab.your-company.com</a></p>
<p>Enter the token you obtained to register the Runner:</p>
<p>输入上面提到的页面里获取的 token</p>
<p>Please enter the gitlab-ci description for this runner: 后续可在 gitlab 界面中修改</p>
<p>[hostame]: 比如输入 192.x.x.9Shell 作为 runner 的描述，暗示会使用 192.x.x.9 上的 Shell 作为运行环境，或是 192.x.x.9Docker ，或是其它可以适当描述的字符</p>
<p>Please enter the gitlab-ci tags for this runner (comma separated): 可以为空，如果不为空或后续在 gitlab 界面中修改的话，则使得 <code>.gitlab-ci.yml</code> 中的某个 job 有了这样的能力 —— 如果 job 中存在 tag 关键字时那就只有相同 tag 的 Runner 才允许运行这个 job</p>
<p>Whether to run untagged jobs [true/false]: 如果上面一条不为空，则会出现此条，后续可在 gitlab 界面中修改</p>
<p>[false]: 当 <code>.gitlab-ci.yml</code> 中的某个 job 中不存在 tag 关键字时，是否允许当前这个被上一条 tag 过的 Runner 运行这个 job</p>
<p>Whether to lock Runner to current project [true/false]: 后续可在 gitlab 界面中修改</p>
<p>[false]: 后续在 gitlab 界面中修改使之按需（单向）转变为 specific Runner 即可</p>
<p>Registering runner... succeeded                     runner=上面 token 的前 8 个字符</p>
<p>Please enter the executor: docker-ssh, shell, virtualbox, kubernetes, docker, parallels, ssh, docker+machine, docker-ssh+machine:</p>
<p>选择其中之一，常用的有 shell 或者是 docker ，可以输入 shell 并回车后， 当前的 Runner 就配置好了。</p>
<p>如果上一条输入的是 docker ，则还会出现下一条：</p>
<p>Please enter the Docker image (eg. ruby:2.1):</p>
<p>可以输入某个合适的 docker 镜像名比如比较流行的体积很小的 alpine<!-- -->:latest<!-- --> 并回车后， 当前的 Runner 就配置好了。</p>
<p>此时，使用 <code>sudo gitlab-runner list</code> 命令就能看到已注册的 runner 列表了。更多命令使用方法详见 <a href="http://docs.gitlab.com/runner/commands/README.html" target="_blank" rel="noopener noreferrer">GitLab Runner Commands</a> 。</p>
<p><a href="http://docs.gitlab.com/runner/executors/README.html" target="_blank" rel="noopener noreferrer">Executors</a> 中介绍了各个 excutor 的异同。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="shell-executor">Shell executor<a href="#shell-executor" class="hash-link" aria-label="Direct link to Shell executor" title="Direct link to Shell executor" translate="no">​</a></h3>
<p>Shell executor 相对其它 executor 来说比较容易理解和操作，在初期可以拿来熟悉 job 的运行方式。</p>
<p>在执行 job 的 script 中的命令时所需的各种依赖，比如 npm 命令本身需要安装到 /home/gitlab-runner 这个用户能够访问的路径中，可能比较麻烦，而且难以保证各个 Runner 上安装的各个软件的版本都相同，所以后期需要使用 Docker executor 。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="docker-executor">Docker executor<a href="#docker-executor" class="hash-link" aria-label="Direct link to Docker executor" title="Direct link to Docker executor" translate="no">​</a></h3>
<p>如果想用 Docker executor ，则在使用 Runner 之前请先安装 docker ：</p>
<p>curl -sSL <a href="https://get.docker.com/" target="_blank" rel="noopener noreferrer">https://get.docker.com/</a> | sh</p>
<p>至于实际使用的 docker 镜像，虽说可以在使用默认的比如 alpine<!-- -->:latest<!-- --> 或是 <code>.gitlab-ci.yml</code> 文件里指定的 image: node<!-- -->:latest<!-- --> 时，在  <code>.gitlab-ci.yml</code> 文件里另外安装一些必须的工具，就像下面做的那样：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">before_script:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - apt-get update -qq &amp;&amp; apt-get install -qq rsync sshpass</span><br></span></code></pre></div></div>
<p>但是 <code>apt-get</code> 有时也会碰到 <code>Could not resolve &#x27;cdn-fastly.deb.debian.org&#x27;</code> 这样的网络问题，再考虑到 latest 所代表的意义是经常要从国内访问不太稳定的 DockerHub 上 pull 最新版本的镜像，所以最好是自己编译一个合适的特定版本镜像来长久使用，比如 <a href="https://hub.docker.com/r/flyskywhy/java-nodejs/tags/" target="_blank" rel="noopener noreferrer">flyskywhy/java-nodejs<!-- -->:v8<!-- -->.3.0</a> 。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="为-docker-executor-配置-dns">为 Docker executor 配置 DNS<a href="#为-docker-executor-配置-dns" class="hash-link" aria-label="Direct link to 为 Docker executor 配置 DNS" title="Direct link to 为 Docker executor 配置 DNS" translate="no">​</a></h4>
<p>当然，严格来说，上面 <code>apt-get</code> 碰到的网络问题，与第一次使用 <code>Docker executor</code> 运行 job 时极可能会遇到的 <code>fatal: unable to access &#x27;http://gitlab-ci-token:xxxxxxxxxxxxxxxxxxxx@gitlab.your-company.com/path/to/your/project.git/&#x27;: Couldn&#x27;t resolve host &#x27;gitlab.your-company.com&#x27;</code> 属于同一个问题，解决方法是按照 <a href="https://gitlab.com/gitlab-org/gitlab-ci-multi-runner/blob/master/docs/configuration/advanced-configuration.md#the-runnersdocker-section" target="_blank" rel="noopener noreferrer">GitLab CI Runner Advanced configuration</a> 中的描述，修改 <code>/etc/gitlab-runner/config.toml</code> 文件，在 <code>[runners.docker]</code> 小节中添加 <code>dns = [&quot;114.114.114.114&quot;]</code> ，或者是添加 <code>extra_hosts = [&quot;gitlab.your-company.com:192.x.x.7&quot;]</code> ，然后运行 <code>sudo gitlab-runner verify</code> 确认没有修改出错误，最后在 gitlab 上再次运行 job 即可。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="把容器提交为-docker-镜像">把容器提交为 docker 镜像<a href="#把容器提交为-docker-镜像" class="hash-link" aria-label="Direct link to 把容器提交为 docker 镜像" title="Direct link to 把容器提交为 docker 镜像" translate="no">​</a></h4>
<p>用 <code>docker run -i -t your-name/your-repo /bin/bash</code> 命令把镜像变成容器运行后，在其中进行了一些修改，就可以用 <code>docker commit</code> 命令将该容器转换成 docker 镜像。只不过这样的镜像只能被 docker 管理，如果需要同时也被 git 管理的，则可以使用下面的 Dockerfile 。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="从-dockerfile-编译为-docker-镜像">从 Dockerfile 编译为 docker 镜像<a href="#从-dockerfile-编译为-docker-镜像" class="hash-link" aria-label="Direct link to 从 Dockerfile 编译为 docker 镜像" title="Direct link to 从 Dockerfile 编译为 docker 镜像" translate="no">​</a></h4>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="编写-dockerfile">编写 Dockerfile<a href="#编写-dockerfile" class="hash-link" aria-label="Direct link to 编写 Dockerfile" title="Direct link to 编写 Dockerfile" translate="no">​</a></h5>
<p>可以参考一些现有的 Dockerfile 比如 <a href="https://github.com/flyskywhy/docker-java-nodejs/blob/master/Dockerfile" target="_blank" rel="noopener noreferrer">docker-java-nodejs_Dockerfile</a> 及 <a href="https://itbilu.com/linux/docker/VyhM5wPuz.html" target="_blank" rel="noopener noreferrer">Docker镜像构建文件Dockerfile及相关命令介绍</a> 一文来编写适合自己项目的 Dockerfile 。</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="手动从-dockerfile-编译-docker-镜像">手动从 Dockerfile 编译 docker 镜像<a href="#手动从-dockerfile-编译-docker-镜像" class="hash-link" aria-label="Direct link to 手动从 Dockerfile 编译 docker 镜像" title="Direct link to 手动从 Dockerfile 编译 docker 镜像" translate="no">​</a></h5>
<p>可以使用 <code>docker build -t your-name/your-repo:repo-tag .</code> 这样的命令来把当前目录中的 Dockerfile 编译成一个 docker 镜像（会被自动自动保存到 <code>/var/lib/docker/</code> 中），此时在 <code>.gitlab-ci.yml</code> 文件中写上 <code>image: your-name/your-repo:repo-tag</code> 后， Gitlab CI 就已经能使用该镜像了。后续还可以用 <code>docker push your-name/your-repo:repo-tag</code> 命令上传到 DockerHub 上。</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="自动从-dockerfile-编译-docker-镜像">自动从 Dockerfile 编译 docker 镜像<a href="#自动从-dockerfile-编译-docker-镜像" class="hash-link" aria-label="Direct link to 自动从 Dockerfile 编译 docker 镜像" title="Direct link to 自动从 Dockerfile 编译 docker 镜像" translate="no">​</a></h5>
<p>还有更自动、方便的方法——让 DockerHub 自动把 GitHub 上的 Dockerfile 拉过去编译，我们只需要 <code>docker pull</code> 去使用镜像即可，这同时也避免了因为国内网络问题导致的 <code>docker build</code> 或 <code>docker push</code> 偶尔会失败几次。</p>
<p>自动编译 docker 镜像的方法是，按照 <a href="https://docs.docker.com/docker-hub/builds/#link-to-a-hosted-repository-service" target="_blank" rel="noopener noreferrer">Configure automated builds on Docker Hub</a> 中所说，在登录后的 <a href="https://hub.docker.com" target="_blank" rel="noopener noreferrer">Docker Hub</a> 网站的 <code>Profile &gt; Settings &gt; Linked Accounts &amp; Services</code> 中选择 <code>Github</code> ，然后选择 <code>Public and Private</code> ，然后自动跳转到 GitHub 网站确认后，就可以在 DockerHub 网站的 <code>Create &gt; Create Automated Build</code> 中选择包含 Dockerfile 的某个 GitHub repository 来创建可自动编译的 DockerHub repository 。今后只要在该 GitHub repository 中进行了 commit 或 push 的操作， DockerHub 就会自动编译出相应的 docker 镜像。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="为-docker-executor-配置缓存">为 Docker executor 配置缓存<a href="#为-docker-executor-配置缓存" class="hash-link" aria-label="Direct link to 为 Docker executor 配置缓存" title="Direct link to 为 Docker executor 配置缓存" translate="no">​</a></h4>
<p><code>/etc/gitlab-runner/config.toml</code> 文件里 <code>[runners.docker]</code> 小节中默认存在</p>
<p>volumes = [&quot;/cache&quot;]</p>
<p>的配置，既是说在容器之间需要缓存的数据是放在容器内的 /cache 卷中，具体对应宿主机上的位置则可以在容器运行时通过 <code>docker ps</code> 得到 <code>容器id</code> 再通过 <code>docker inspect 容器id</code> 得知：</p>
<p>&quot;/cache&quot;: &quot;/var/lib/docker/volumes/08869e6d033a076de6c675e77c491f487434454d8a1939e8da36f803bab6a1ec/_data&quot;</p>
<p>其中存放的实际上就是在 <code>.gitlab-ci.yml</code> 文件中所写的</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cache:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  paths:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - node_modules/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>这个 <code>node_modules/</code> 会被自动压缩为 /cache/your-name/your-project/default/cache.zip ，并在下一个容器中解压缩，如此来实现 <code>.gitlab-ci.yml</code> 文件中的 <code>cache</code> 功能。</p>
<p>由于 docker 有自己的策略来决定何时删除那个 cache.zip ，为了避免偶尔可能因之让我们项目中的 <code>node_modules/</code> 重新去下载，同时为了完全避免每次在容器中下载 <code>~/.npm/</code> ，参考 <a href="https://www.colinodell.com/blog/201704/optimizing-dockerbased-ci-runners-shared-package-caches" target="_blank" rel="noopener noreferrer">Optimizing Docker-Based CI Runners With Shared Package Caches</a> 一文，我们修改 <code>/etc/gitlab-runner/config.toml</code> 文件内容：</p>
<p>volumes = [&quot;/srv/cache:/cache<!-- -->:rw<!-- -->&quot;]</p>
<p>并在 <code>.gitlab-ci.yml</code> 文件中编写如下内容：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">before_script:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - export YARN_CACHE_FOLDER=/cache/yarn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - export NPM_CONFIG_CACHE=/cache/npm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - export bower_storage__packages=/cache/bower</span><br></span></code></pre></div></div>
<p>即可。</p>
<p>此种配置下用 <code>docker inspect 容器id</code> 就会看到：</p>
<p>&quot;/cache&quot;: &quot;/srv/cache&quot;</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="一些-docker-常见错误的解决">一些 docker 常见错误的解决<a href="#一些-docker-常见错误的解决" class="hash-link" aria-label="Direct link to 一些 docker 常见错误的解决" title="Direct link to 一些 docker 常见错误的解决" translate="no">​</a></h4>
<p>如果 Gitlab 的 <code>Pipelines ➔ Jobs</code> 中的命令行打印出 <code>System error: open /sys/fs/cgroup/cpu,cpuacct/init.scope/system.slice/</code> 这样的错误，则需要：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sudo vi /lib/systemd/system/docker.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[Service]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ExecStart=/usr/bin/docker -d -H fd:// --exec-opt native.cgroupdriver=cgroupfs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">然后再通过如下方式来使能上述配置：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo systemctl daemon-reload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo service docker stop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo service docker start</span><br></span></code></pre></div></div>
<p>如果 docker pull 时碰到 timeout ，那是因为墙引起的 DockerHub 网络不稳定，多试几次就好了，或者换到国内的源比如 DaoCloud ，或者直接按照 <a href="https://docs.gitlab.com/runner/executors/docker.html#how-pull-policies-work" target="_blank" rel="noopener noreferrer">How pull policies work</a> 中所说，在 <code>/etc/gitlab-runner/config.toml</code> 文件里 <code>[runners.docker]</code> 小节中添加</p>
<p>pull_policy = &quot;never&quot;</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="virtualbox-executor">VirtualBox executor<a href="#virtualbox-executor" class="hash-link" aria-label="Direct link to VirtualBox executor" title="Direct link to VirtualBox executor" translate="no">​</a></h3>
<p>可以用来在虚拟机中的 macOS 中编译 iOS APP ，参见 <a href="/g/docs/i主观的体验方式/t快乐的体验/电信/Tool/编程语言/JavaScript/ReactNative项目中命令行编译iOS版的方法">ReactNative项目中命令行编译iOS版的方法</a> 。实际使用中发现用 <code>Shell executor</code> 连接持续开启中的 macOS 虚拟机也是挺方便的。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="将-runner-运行在-docker-中">将 Runner 运行在 docker 中<a href="#将-runner-运行在-docker-中" class="hash-link" aria-label="Direct link to 将 Runner 运行在 docker 中" title="Direct link to 将 Runner 运行在 docker 中" translate="no">​</a></h3>
<p>按照 <a href="http://docs.gitlab.com/runner/install/docker.html" target="_blank" rel="noopener noreferrer">Run GitLab Runner in a container</a> 所说，如果你的项目的确有这个需求，你甚至能将 Runner 本身运行在 docker 中！</p>
<h1>持续部署 CD</h1>
<p>按照 <a href="https://docs.gitlab.com/ce/ci/environments.html" target="_blank" rel="noopener noreferrer">Introduction to environments and deployments</a> 一文我们可以进行持续部署。</p>
<p>Project 的 <code>Pipelines ➔ Environments</code> 页面中的那个 <code>New environment</code> 不建议使用，而是在 job 中来建立。</p>
<p>在比如下面的 job 中：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">deploy_staging:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  stage: deploy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  script:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - echo &quot;Deploy to staging server&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  environment:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name: staging</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    url: https://staging.example.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  only:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - master</span><br></span></code></pre></div></div>
<p>我们设定了 environment 是 staging ，这样当这个 job 被 Runner 执行后，我们就会在 Project 的 <code>Pipelines ➔ Environments</code> 中看到一个叫做 staging 的 environment 中的部署历史记录，在历史记录多于一个时，会看到旧的历史记录上的按钮变成了 Rollback ，如果网站足够简单就可以方便地点击该按钮进行部署回滚。</p>
<p>这里的 url 会在 gitlab 的许多网页中出现，当上面的 script 中比如用 rsync 命令真正地去部署后，这些网页中的这些 url 就能真正点击进入了。</p>
<p>一般在 rsync 中会用到部署目标服务器的用户名和密码，这些需要保密的变量名字需要设置在 <code>Settings ➔ Pipelines</code> 页面中的 <code>Secret variables</code> 处。在 <code>Settings ➔ Members</code> 中可以添加其它用户作为 Guest 、 Reporter 、 Developer 、 Master 中的某个角色，而除了 Master 以外，其它角色都不能访问 <code>Settings ➔ Pipelines</code> 页面。另外，如果担心 <code>Pipelines ➔ Jobs</code> 中的命令行打印信息透露一些细节，还可以在 <code>Settings ➔ Pipelines</code> 页面中去掉 <code>Public pipelines</code> 的勾选。</p>
<p>比如在 <code>Secret variables</code> 中添加了 DEPLOY_USER 和 DEPLOY_PASSWORD 之后，就可以如 <a href="https://docs.gitlab.com/ce/ci/variables/README.html" target="_blank" rel="noopener noreferrer">Variables</a> 中所说，在 job 中的 script 里写成如下形式：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  script:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - sshpass -p $DEPLOY_PASSWORD rsync -avuzq build/ -e &#x27;ssh -oStrictHostKeyChecking=no&#x27; $DEPLOY_USER@112.113.114.115:~/your-project/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - sshpass -p $DEPLOY_PASSWORD ssh -o StrictHostKeyChecking=no $DEPLOY_USER@112.113.114.115 &quot;. .profile &amp;&amp; cd ~/your-project/ &amp;&amp; pm2 restart pm2.config.js&quot;</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="直接编译为-docker-镜像并进行部署">直接编译为 docker 镜像并进行部署<a href="#直接编译为-docker-镜像并进行部署" class="hash-link" aria-label="Direct link to 直接编译为 docker 镜像并进行部署" title="Direct link to 直接编译为 docker 镜像并进行部署" translate="no">​</a></h2>
<p>目前业界有一种趋势：直接将应用代码编译为一个 docker 镜像，然后运行这个镜像中的应用代码的测试脚本，然后把这个测试通过的镜像 push 到（自己私有的） Docker Registry 中，最后把这个镜像从 Docker Registry 中部署到生产服务器上。不过正如 <a href="https://docs.gitlab.com/ce/ci/docker/using_docker_build.html" target="_blank" rel="noopener noreferrer">Using Docker Build</a> 中所说，三种实现该目标的方法各有利弊，需要权衡选择。另外根据 <a href="http://www.linuxeden.com/a/9864" target="_blank" rel="noopener noreferrer">Spotify 的容器使用情况</a> 中所说，如果使用这种方式，还需要承担 docker 自身可能出现的一些问题。总的来说，请根据项目实际需要，权衡是否选择此种部署方式。具体操作可以参考 <a href="/g/docs/i主观的体验方式/t快乐的体验/电信/Tool/配置管理/Git/GitLab自动部署nodejs应用到阿里云Kubernetes集群中">GitLab自动部署nodejs应用到阿里云Kubernetes集群中</a> 一文。</p>
<h1>https</h1>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="首次添加-ssl-证书">首次添加 SSL 证书<a href="#首次添加-ssl-证书" class="hash-link" aria-label="Direct link to 首次添加 SSL 证书" title="Direct link to 首次添加 SSL 证书" translate="no">​</a></h2>
<p>gitlab 默认是 http 的，如果想开启 https ，首先需要比如到 <a href="http://www.cnblogs.com/joshua317/p/6179311.html" target="_blank" rel="noopener noreferrer">阿里云免费申请免费SSL证书</a> ，然后参考 <a href="https://docs.gitlab.com/omnibus/settings/nginx.html" target="_blank" rel="noopener noreferrer">NGINX settings</a> 将获得的证书复制并重命名，比如：</p>
<p>sudo mkdir -p /etc/gitlab/ssl
sudo chmod 700 /etc/gitlab/ssl
sudo cp 123456789012345.key /etc/gitlab/ssl/gitlab.your-company.com.key
sudo cp 123456789012345.pem /etc/gitlab/ssl/gitlab.your-company.com.crt</p>
<p>再搜索并修改 <code>/etc/gitlab/gitlab.rb</code> 中相应的条目：</p>
<p>external_url &#x27;<a href="http://gitlab.your-company.com" target="_blank" rel="noopener noreferrer">http://gitlab.your-company.com</a>&#x27;
nginx[&#x27;redirect_http_to_https&#x27;] = true</p>
<p>最后 <code>sudo gitlab-ctl reconfigure</code> 即可。</p>
<p>最后的最后，如果之前配置过 Runner ，则还需到 Runner 的服务器上将 <code>/etc/gitlab-runner/config.toml</code> 文件里的 url 修改为 https 的并 <code>sudo gitlab-runner restart</code> 即可。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="以后更新-ssl-证书">以后更新 SSL 证书<a href="#以后更新-ssl-证书" class="hash-link" aria-label="Direct link to 以后更新 SSL 证书" title="Direct link to 以后更新 SSL 证书" translate="no">​</a></h2>
<p>复制新证书到 <code>/etc/gitlab/ssl/</code> 后，执行</p>
<p>sudo gitlab-ctl hup nginx</p>
<h1>npm install</h1>
<p>如果托管在 gitlab 中的仓库想要被 <code>npm install</code> 安装，比如 <code>npm install git+https://gitlab.your-company.com/github/flyskywhy/react-web.git#5856028</code> ，则需要在 gitlab 网页上设置该仓库 <code>Settings | General | Project Visibility</code> 为 <code>Public</code> 。否则会报例如如下错误：</p>
<p>npm ERR! fatal: Authentication failed for &#x27;<a href="https://gitlab.your-company.com/github/flyskywhy/react-web.git/" target="_blank" rel="noopener noreferrer">https://gitlab.your-company.com/github/flyskywhy/react-web.git/</a>&#x27;</p>
<h1>403 Forbidden</h1>
<p>如果未经授权访问 gitlab 上的仓库超过默认的 10 次（ <code>/etc/gitlab/gitlab.rb</code> 中 maxretry 为 10 ），比如前述 <code>npm install</code> 出错超过 10 次，则会无法访问 gitlab 一小时。解决的方法是临时修改 <code>/etc/gitlab/gitlab.rb</code> 中的</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># gitlab_rails[&#x27;rack_attack_git_basic_auth&#x27;] = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Rack Attack IP banning enabled</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#   &#x27;enabled&#x27; =&gt; true,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Whitelist requests from 127.0.0.1 for web proxies (NGINX/Apache) with incorrect headers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#   &#x27;ip_whitelist&#x27; =&gt; [&quot;127.0.0.1&quot;],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Limit the number of Git HTTP authentication attempts per IP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#   &#x27;maxretry&#x27; =&gt; 10,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Reset the auth attempt counter per IP after 60 seconds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#   &#x27;findtime&#x27; =&gt; 60,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Ban an IP for one hour (3600s) after too many auth attempts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#   &#x27;bantime&#x27; =&gt; 3600</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># }</span><br></span></code></pre></div></div>
<p>为</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> gitlab_rails[&#x27;rack_attack_git_basic_auth&#x27;] = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   &#x27;enabled&#x27; =&gt; false,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#   &#x27;ip_whitelist&#x27; =&gt; [&quot;127.0.0.1&quot;],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#   &#x27;maxretry&#x27; =&gt; 10,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#   &#x27;findtime&#x27; =&gt; 60,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#   &#x27;bantime&#x27; =&gt; 3600</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> }</span><br></span></code></pre></div></div>
<p>然后 <code>sudo gitlab-ctl reconfigure</code> ，确认可以访问 gitlab 了，再修改回来后 <code>sudo gitlab-ctl reconfigure</code> 即可。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="一些-bug-的解决方法">一些 BUG 的解决方法<a href="#一些-bug-的解决方法" class="hash-link" aria-label="Direct link to 一些 BUG 的解决方法" title="Direct link to 一些 BUG 的解决方法" translate="no">​</a></h2>
<p>如果往 gitlab 上传了类似 Linux <code>kernel.git</code> 那种提交点特别多的仓库后（或是 gitlab 中 git 仓库越来越多？），出现 <code>git fsck</code> 进程占用 100% CPU 导致服务器卡死的问题，可以参考 <a href="https://gitlab.com/gitlab-org/omnibus-gitlab/-/issues/3256" target="_blank" rel="noopener noreferrer">Git fsck memory leak (#3256) · Issues · GitLab.org</a> 在 root 帐号登录 gitlab 后的 &quot;Admin area&quot; 的 &quot;Settings&quot; 页面里不勾选 <code>Enable Repository Checks</code> 。</p>
<p>如果发现有时 gitlay 进程占用 100% CPU ，可以参考 <a href="https://gitlab.com/gitlab-org/gitlab-foss/-/issues/42575" target="_blank" rel="noopener noreferrer">High Gitaly CPU usage_load average causing issues (#42575) · Issues · GitLab.org</a> 在运行 gitlab 的 Linux 服务器的 <code>/etc/security/limit.conf</code> 中添加</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">git soft nproc 10240</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">git hard nproc 10240</span><br></span></code></pre></div></div></div></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/g/docs/i主观的体验方式/t快乐的体验/电信/Tool/翻墙/翻墙起点"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">&lt;center&gt;翻墙起点&lt;/center&gt;</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/g/docs/i主观的体验方式/t快乐的体验/电信/Tool/配置管理/Git/GitLab自动部署nodejs应用到阿里云Kubernetes集群中"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">GitLab自动部署nodejs应用到阿里云Kubernetes集群中</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#首次启动" class="table-of-contents__link toc-highlight">首次启动</a></li><li><a href="#解决-80-端口被占问题" class="table-of-contents__link toc-highlight">解决 80 端口被占问题</a><ul><li><a href="#与其它程序共享-80-端口" class="table-of-contents__link toc-highlight">与其它程序共享 80 端口</a></li><li><a href="#将-gitlab-的-80-端口进行调整" class="table-of-contents__link toc-highlight">将 gitlab 的 80 端口进行调整</a></li></ul></li><li><a href="#解决-8080-端口被占问题" class="table-of-contents__link toc-highlight">解决 8080 端口被占问题</a></li><li><a href="#邮件发送测试" class="table-of-contents__link toc-highlight">邮件发送测试</a></li><li><a href="#mount-nfs" class="table-of-contents__link toc-highlight">mount nfs</a></li><li><a href="#创建-gitlab-ciyml-文件" class="table-of-contents__link toc-highlight">创建 .gitlab-ci.yml 文件</a><ul><li><a href="#下载-artifacts" class="table-of-contents__link toc-highlight">下载 artifacts</a></li></ul></li><li><a href="#配置-runner" class="table-of-contents__link toc-highlight">配置 Runner</a><ul><li><a href="#shell-executor" class="table-of-contents__link toc-highlight">Shell executor</a></li><li><a href="#docker-executor" class="table-of-contents__link toc-highlight">Docker executor</a></li><li><a href="#virtualbox-executor" class="table-of-contents__link toc-highlight">VirtualBox executor</a></li><li><a href="#将-runner-运行在-docker-中" class="table-of-contents__link toc-highlight">将 Runner 运行在 docker 中</a></li></ul></li><li><a href="#直接编译为-docker-镜像并进行部署" class="table-of-contents__link toc-highlight">直接编译为 docker 镜像并进行部署</a></li><li><a href="#首次添加-ssl-证书" class="table-of-contents__link toc-highlight">首次添加 SSL 证书</a></li><li><a href="#以后更新-ssl-证书" class="table-of-contents__link toc-highlight">以后更新 SSL 证书</a></li><li><a href="#一些-bug-的解决方法" class="table-of-contents__link toc-highlight">一些 BUG 的解决方法</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/g/docs">Docs</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://x.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">X<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/g/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/flyskywhy/g" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>