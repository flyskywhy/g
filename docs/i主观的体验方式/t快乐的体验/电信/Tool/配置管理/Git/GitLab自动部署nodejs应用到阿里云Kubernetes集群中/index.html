<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-i主观的体验方式/t快乐的体验/电信/Tool/配置管理/Git/GitLab自动部署nodejs应用到阿里云Kubernetes集群中" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.1">
<title data-rh="true">GitLab自动部署nodejs应用到阿里云Kubernetes集群中 | My Site</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://flyskywhy.github.io/g/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://flyskywhy.github.io/g/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://flyskywhy.github.io/g/docs/i主观的体验方式/t快乐的体验/电信/Tool/配置管理/Git/GitLab自动部署nodejs应用到阿里云Kubernetes集群中"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="GitLab自动部署nodejs应用到阿里云Kubernetes集群中 | My Site"><meta data-rh="true" name="description" content="Li Zheng flyskywhy@gmail.com"><meta data-rh="true" property="og:description" content="Li Zheng flyskywhy@gmail.com"><link data-rh="true" rel="icon" href="/g/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://flyskywhy.github.io/g/docs/i主观的体验方式/t快乐的体验/电信/Tool/配置管理/Git/GitLab自动部署nodejs应用到阿里云Kubernetes集群中"><link data-rh="true" rel="alternate" href="https://flyskywhy.github.io/g/docs/i主观的体验方式/t快乐的体验/电信/Tool/配置管理/Git/GitLab自动部署nodejs应用到阿里云Kubernetes集群中" hreflang="en"><link data-rh="true" rel="alternate" href="https://flyskywhy.github.io/g/docs/i主观的体验方式/t快乐的体验/电信/Tool/配置管理/Git/GitLab自动部署nodejs应用到阿里云Kubernetes集群中" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"GitLab自动部署nodejs应用到阿里云Kubernetes集群中","item":"https://flyskywhy.github.io/g/docs/i主观的体验方式/t快乐的体验/电信/Tool/配置管理/Git/GitLab自动部署nodejs应用到阿里云Kubernetes集群中"}]}</script><link rel="alternate" type="application/rss+xml" href="/g/blog/rss.xml" title="My Site RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/g/blog/atom.xml" title="My Site Atom Feed"><link rel="stylesheet" href="/g/assets/css/styles.faf98e1c.css">
<script src="/g/assets/js/runtime~main.c73eebbf.js" defer="defer"></script>
<script src="/g/assets/js/main.31007980.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/g/img/logo.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/g/"><div class="navbar__logo"><img src="/g/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/g/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">My Site</b></a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/g/docs/">文档</a><a href="https://github.com/flyskywhy/g" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/g/docs/"><span title="README" class="linkLabel_WmDU">README</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/g/docs/i主观的体验方式/i悲伤的体验/中医/中药的“威力”"><span title="i主观的体验方式" class="categoryLinkLabel_W154">i主观的体验方式</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/g/docs/i主观的体验方式/i悲伤的体验/中医/中药的“威力”"><span title="i悲伤的体验" class="categoryLinkLabel_W154">i悲伤的体验</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/商/Pm/小团队项目管理软件的的选择"><span title="t快乐的体验" class="categoryLinkLabel_W154">t快乐的体验</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/商/Pm/小团队项目管理软件的的选择"><span title="商" class="categoryLinkLabel_W154">商</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/处世/如何做好人生最重要的事——选择"><span title="处世" class="categoryLinkLabel_W154">处世</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/手机/手机投屏到手机的方法"><span title="手机" class="categoryLinkLabel_W154">手机</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/政/atLJJ"><span title="政" class="categoryLinkLabel_W154">政</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/电信/Cpu/Riscv/LicheeRV使用详解"><span title="电信" class="categoryLinkLabel_W154">电信</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-4 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/电信/Cpu/Riscv/LicheeRV使用详解"><span title="Cpu" class="categoryLinkLabel_W154">Cpu</span></a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/电信/Education/"><span title="README" class="linkLabel_WmDU">README</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-4 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/电信/Fs/Ipfs/Ipfs使用详解"><span title="Fs" class="categoryLinkLabel_W154">Fs</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-4 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/电信/Net/Vpn/VPN路由设置详解"><span title="Net" class="categoryLinkLabel_W154">Net</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-4 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/电信/Os/AliOsThings/BoneEngine使用详解"><span title="Os" class="categoryLinkLabel_W154">Os</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-4 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/电信/Test/Firebase使用详解"><span title="Test" class="categoryLinkLabel_W154">Test</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-4 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/电信/Tool/Probe/Fs2/mips仿真器gdb调试方法"><span title="Tool" class="categoryLinkLabel_W154">Tool</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-5 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/电信/Tool/Probe/Fs2/mips仿真器gdb调试方法"><span title="Probe" class="categoryLinkLabel_W154">Probe</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-5 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/电信/Tool/文件管理/Syncthing/Syncthing在网络化测试机项目中的应用方式"><span title="文件管理" class="categoryLinkLabel_W154">文件管理</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-5 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/电信/Tool/文档编辑/Maqetta/Maqetta使用详解"><span title="文档编辑" class="categoryLinkLabel_W154">文档编辑</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-5 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/电信/Tool/编程语言/C/C语言编码规范"><span title="编程语言" class="categoryLinkLabel_W154">编程语言</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-5 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/电信/Tool/翻墙/Clash使用详解"><span title="翻墙" class="categoryLinkLabel_W154">翻墙</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-5 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/电信/Tool/配置管理/Git/GitLab使用详解"><span title="配置管理" class="categoryLinkLabel_W154">配置管理</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-6 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/电信/Tool/配置管理/Git/GitLab使用详解"><span title="Git" class="categoryLinkLabel_W154">Git</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-7 menu__list-item"><a class="menu__link" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/电信/Tool/配置管理/Git/GitLab使用详解"><span title="GitLab使用详解" class="linkLabel_WmDU">GitLab使用详解</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-7 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/电信/Tool/配置管理/Git/GitLab自动部署nodejs应用到阿里云Kubernetes集群中"><span title="GitLab自动部署nodejs应用到阿里云Kubernetes集群中" class="linkLabel_WmDU">GitLab自动部署nodejs应用到阿里云Kubernetes集群中</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-7 menu__list-item"><a class="menu__link" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/电信/Tool/配置管理/Git/Git最简培训"><span title="Git最简培训" class="linkLabel_WmDU">Git最简培训</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-7 menu__list-item"><a class="menu__link" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/电信/Tool/配置管理/Git/msysgit使用详解"><span title="msysgit使用详解" class="linkLabel_WmDU">msysgit使用详解</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-7 menu__list-item"><a class="menu__link" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/电信/Tool/配置管理/Git/《不拉马的士兵》与git仓库管理方式"><span title="《不拉马的士兵》与git仓库管理方式" class="linkLabel_WmDU">《不拉马的士兵》与git仓库管理方式</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-7 menu__list-item"><a class="menu__link" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/电信/Tool/配置管理/Git/制作git中心仓库的方法"><span title="制作git中心仓库的方法" class="linkLabel_WmDU">制作git中心仓库的方法</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-7 menu__list-item"><a class="menu__link" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/电信/Tool/配置管理/Git/前端CDN网址跨域访问后端nodejs应用负载均衡网址的方法"><span title="前端CDN网址跨域访问后端nodejs应用负载均衡网址的方法" class="linkLabel_WmDU">前端CDN网址跨域访问后端nodejs应用负载均衡网址的方法</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-7 menu__list-item"><a class="menu__link" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/电信/Tool/配置管理/Git/将已有的Markdown文档Git仓库自动转为网页并托管为网站"><span title="将已有的Markdown文档Git仓库自动转为网页并托管为网站" class="linkLabel_WmDU">将已有的Markdown文档Git仓库自动转为网页并托管为网站</span></a></li></ul></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-4 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/电信/Video/PyTorch使用详解"><span title="Video" class="categoryLinkLabel_W154">Video</span></a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/画/Ai/fastsdcpu使用详解"><span title="画" class="categoryLinkLabel_W154">画</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/g/docs/i主观的体验方式/t快乐的体验/行/杭州老和山游步道、杭州乐园2日游"><span title="行" class="categoryLinkLabel_W154">行</span></a></div></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/g/docs/t客观的存在原理/i人体内部的存在/t肉体/现代医学的哲学理念"><span title="t客观的存在原理" class="categoryLinkLabel_W154">t客观的存在原理</span></a></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/g/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">i主观的体验方式</span></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">t快乐的体验</span></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">电信</span></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Tool</span></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">配置管理</span></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Git</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">GitLab自动部署nodejs应用到阿里云Kubernetes集群中</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><p>Li Zheng <a href="mailto:flyskywhy@gmail.com" target="_blank" rel="noopener noreferrer">flyskywhy@gmail.com</a></p>
<header><h1>gitlab 自动部署 nodejs 应用到阿里云 Kubernetes 集群中</h1></header>
<p>使用 ECS 部署的基本步骤：将程序复制到 ECS 某个目录中然后发命令给 ECS 启动程序。</p>
<p>使用 K8S 部署的基本步骤：将程序制作为 docker 镜像并复制到阿里云镜像仓库中然后发命令给阿里云 Kubernetes 去取镜像并运行。</p>
<p>考虑到 gitlab 免费版 DevOps 自动部署模块最近新增的 Kubernetes 功能只支持一个 Kubernetes 集群，而任何版本的 gitlab 中对 Kubernetes 的一些额外支持如 Kubernetes 应用市场等功能，与商业收费的阿里云 Kubernetes 产品中的功能重复，所以抛开 gitlab 自带的 Kubernetes 功能，直接使用 kubectrl 命令行工具来连接 gitlab 自动部署脚本和阿里云 Kubernetes 产品的方法最为低耦合、低费用，这里低耦合的意思是在保证 CI/CD 基本流程不变的情况下，随时切换其中的 ECS 或 K8S 部署，参见下图：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">                                                  负载均衡到 ECS 或 docker 中的</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">浏览器 &lt;======&gt; 阿里云 CDN 判断是否访问静态文件 &lt;===n===&gt; nginx 判断是否访问静态文件 &lt;===n===&gt; ECS 或 docker 中的后端进程</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ^                       |                             ^            ^                          ^</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   |                      y|                             |           y|                          |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   |                       ⌄                             |            ⌄                          |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   =======y======= CDN 是否已有缓存 &lt;===n===================     阿里云 OSS 中的前端文件 &lt;=== 运行 gitlab 自动部署脚本</span><br></span></code></pre></div></div>
<p>图中可以看到对于静态文件的判断，阿里云 CDN 和 nginx 是有重复操作的，后文会提到使用跨域访问来优化的方法。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="在阿里云中开启容器仓库">在阿里云中开启容器仓库<a href="#在阿里云中开启容器仓库" class="hash-link" aria-label="Direct link to 在阿里云中开启容器仓库" title="Direct link to 在阿里云中开启容器仓库" translate="no">​</a></h2>
<p>如果是用阿里云子账号来操作容器仓库的，需要添加 <a href="https://help.aliyun.com/document_detail/67992.html" target="_blank" rel="noopener noreferrer">仓库访问控制</a> 中描述的权限。</p>
<p>用阿里云主账号或子账号进入阿里云 <a href="https://cr.console.aliyun.com/" target="_blank" rel="noopener noreferrer">容器镜像服务</a> 的镜像列表页面，点击“修改Registry登录密码”按钮，以创建今后使用 <code>docker login</code> 命令时的密码。</p>
<p>进入阿里云 <a href="https://cr.console.aliyun.com/" target="_blank" rel="noopener noreferrer">容器镜像服务</a> 的命名空间管理页面，点击“创建命名空间”按钮，用公司名或人名作为命名空间，以便今后在比如阿里云容器 registry 的公网地址 <code>registry.cn-hangzhou.aliyuncs.com/你的命名空间/你的容器名称</code> 中与其他人的容器加以区分。</p>
<p>按 <a href="https://help.aliyun.com/document_detail/60743.html" target="_blank" rel="noopener noreferrer">镜像基本操作</a> 中的描述 <code>docker login</code> 后，就可以开始 docker 其它操作了，详见下文。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="用-docker-生成后端镜像">用 docker 生成后端镜像<a href="#用-docker-生成后端镜像" class="hash-link" aria-label="Direct link to 用 docker 生成后端镜像" title="Direct link to 用 docker 生成后端镜像" translate="no">​</a></h2>
<p>基本思路是在自动部署脚本中生成镜像，因为自动部署脚本一般在容器中执行，为了在 docker 容器中生成 docker 镜像，参考 <a href="http://jpetazzo.github.io/2015/09/03/do-not-use-docker-in-docker-for-ci/" target="_blank" rel="noopener noreferrer">Using Docker-in-Docker for your CI or testing environment? Think twice.</a> ，修改 <code>/etc/gitlab-runner/config.toml</code> 文件内容：</p>
<p>volumes = [&quot;/srv/cache:/cache<!-- -->:rw<!-- -->&quot;， &quot;/var/run/docker.sock:/var/run/docker.sock&quot;]</p>
<p>这里 &quot;/srv/cache:/cache<!-- -->:rw<!-- -->&quot; 意义详见 <a href="/g/docs/i主观的体验方式/t快乐的体验/电信/Tool/配置管理/Git/GitLab使用详解">GitLab使用详解</a> ， &quot;/var/run/docker.sock:/var/run/docker.sock&quot; 意义在于让 docker container 内运行的 docker-cli 命令能够使用 container 外的主机的 docker 环境。</p>
<p>在 gitlab 自动部署脚本 <code>.gitlab-ci.yml</code> 文件中编写如下内容（其中为了加快部署速度和加密 JS 源代码，使用了 <a href="https://github.com/pmq20/node-packer" target="_blank" rel="noopener noreferrer">nodec</a> 来将 <code>index.js</code> <code>node_modules/</code> 等等编译为单独一个可执行文件，参见 <a href="/g/docs/i主观的体验方式/t快乐的体验/电信/Tool/编程语言/JavaScript/nodec使用详解">nodec 使用详解</a>）：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">image: flyskywhy/java-nodejs:v8.3.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deploy-k8s-backend:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  stage: deploy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  cache:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    key: backend</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    paths:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - node_modules/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tags:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - docker # 下面的 nodec 需要 10GB 左右的内存和 10GB 左右的交换空间，所以这里使用了在足够内存和交换空间的电脑上的 tags 叫做 docker 的一个 Gitlab Runner 来运行此自动部署脚本</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  before_script:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - export NPM_CONFIG_CACHE=/cache/npm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - rm -fr __tests__ android app index.android.js index.ios.js index.web.js ios # 删除后端运行时不需要的文件，以减小 nodec 最终生成的可执行文件大小</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - sed -i -e &#x27;/    &quot;react/d&#x27; -e &#x27;/    &quot;redux/d&#x27; -e &#x27;/    &quot;rmc-/d&#x27; package.json # 去除前端依赖，以加快 npm update 速度</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - sed -i -e &quot;s/^{.*/{\&quot;gitSha\&quot;:\&quot;`git rev-parse --short HEAD`\&quot;,/&quot; package.json # 如果 nodejs 应用中想要 git 哈希值的话可以这样做，因为 nodec 最终生成的可执行文件内部是不包含 .git/ 的</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - npm update --production</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - npm run postinstall</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  script:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - /cache/opt/nodec -o nodeapp --skip-npm-install index.js 1&gt;/dev/null 2&gt;&amp;1 # 将所有项目代码编译为一个可执行文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - /cache/opt/docker-cli login -u $ALIYUN_USER -p $ALIYUN_DOCKER_PWD registry.cn-shanghai.aliyuncs.com # 这里的 docker-cli 编译自 https://github.com/docker/cli</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - export DOCKER_IMAGE_NAME=registry.cn-shanghai.aliyuncs.com/你的命名空间/你的容器名称</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - /cache/opt/docker-cli rmi $DOCKER_IMAGE_NAME --force</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - /cache/opt/docker-cli build -t $DOCKER_IMAGE_NAME .</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - /cache/opt/docker-cli push $DOCKER_IMAGE_NAME:latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  only:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - k8s-backend</span><br></span></code></pre></div></div>
<p>其中 <code>docker-cli push</code> 要注意的是，从 ECS 推送镜像时（比如你的 Gitlab Runner 运行在阿里云 ECS 中），可以选择走内网，速度将大大提升，并且将不会损耗您的公网流量。</p>
<ul>
<li>如果您申请的机器是在经典网络，请使用 registry-internal.cn-shanghai.aliyuncs.com 作为registry的域名登录, 并作为镜像名空间前缀</li>
<li>如果您申请的机器是在vpc网络的，请使用 registry-vpc.cn-shanghai.aliyuncs.com 作为registry的域名登录, 并作为镜像名空间前缀</li>
</ul>
<p>其中 <code>docker-cli build</code> 所默认调用的项目根目录中的 Dockerfile 内容如下：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">FROM nginx:1.14 # 因为 19MB 的nginx:1.14-alpine 无法运行需要标准 glibc 的 node 程序，所以退而求其次选择了基于也算比较瘦小的 debian:stretch-slim 制作的 109MB 的 nginx:1.14</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MAINTAINER Li Zheng &lt;flyskywhy@gmail.com&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">COPY nodeapp ./ # 这里是把前面用 nodec 生成的可执行文件复制到镜像中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">COPY scripts/nginx.conf /etc/nginx/conf.d/default.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EXPOSE 8010 # 该值与 nginx.conf 中的 listen 对应</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CMD nginx &amp;&amp; ./nodeapp # nginx 被运行后会自动变成守护进程在后台运行，而基于必须要有一个程序在前台运行否则会自动关闭 docker 容器的概念，这里采用了在前台运行我们的 `node index.js` 应用或是被 nodec 生成的可执行文件的方法</span><br></span></code></pre></div></div>
<p>其中 <code>nginx.conf</code> 的内容如下：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">upstream be_upstream {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    server 127.0.0.1:1234 weight=7;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    keepalive 64;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">server {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    listen 8010;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    #server_name www.YourProject.com # 这一行是不需要的，因为容器里显然最好只运行一项服务，所以没必要只监听（上面的 listen ）一个端口比如 80 然后通过本行来判断分流到不同服务（上面的某个 upstream）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    server_name 127.0.0.1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    client_max_body_size 100m;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if ( $uri = &#x27;/&#x27; ) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rewrite / /index.html last;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    location / {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        proxy_set_header Host $host;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        proxy_set_header X-Real-IP $remote_addr;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        proxy_set_header REMOTE-HOST $remote_addr;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        proxy_next_upstream error timeout invalid_header http_500 http_503;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        proxy_pass http://be_upstream;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    location ~* ^.+\.(html|htm|gif|jpg|jpeg|bmp|png|ico|txt|js|css|woff|woff2|eot|svg|ttf|mp4|avi|mov)$ {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        #proxy_pass http://YourProject-web-release.oss-cn-shanghai-internal.aliyuncs.com; # 生产环境时使用内部 oss 网址以节省 oss 流量</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        proxy_pass http://YourProject-web-release.oss-cn-shanghai.aliyuncs.com; # 调试环境可能无法访问内部 oss 网址，所以需要此行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 主要缓存的是用户通过网页访问时的 react-web 打包的 index.html 和 bundle.js ，因此这里一般可以设置为发版的间隔时间</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        expires 30d;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>上面 <code>nginx.conf</code> 起到了前后端分流的作用：对于后端的访问比如 <code>www.YourProject.com/api/some-api/</code> ，在经过后续会提到的 Kubernetes 部署后，进入了此处 <code>ip地址:8010</code> 里的 <code>nginx.conf</code> 中的 <code>location /</code> 而被分流向后端服务 nodeapp 开启的 1234 端口；同理，对于前端的访问比如 <code>www.YourProject.com</code> 最终会在 <code>nginx.conf</code> 中变成对 <code>/index.html</code> 的访问而被分流向保存着前端静态文件的网盘比如此处的 oss 地址。</p>
<p>参考 <a href="https://stackoverflow.com/questions/9543068/nginx-proxy-pass-to-cdn-vs-hitting-cdn-directly-pros-cons-is-it-slower-or-a" target="_blank" rel="noopener noreferrer">Nginx Proxy_Pass to CDN vs hitting CDN directly. Pro&#x27;s, Con&#x27;s, Is it slower or are there negative effects on the server</a> 一文，为了避免前端静态文件从 oss 取出后还要流经占用 nginx 的资源来提供给浏览器，以及通过 CDN 来访问其回源的负载均衡提供的后端 API 性能相比直接通过负载均衡来访问会差 6 倍甚至可能会出错的问题，则可以抛开本文提供的前后端访问同一域名带来的无需考虑跨域访问 CORS 限制而让编码、调试更方便的优点，再去另外参考 <a href="/g/docs/i主观的体验方式/t快乐的体验/电信/Tool/配置管理/Git/前端CDN网址跨域访问后端nodejs应用负载均衡网址的方法">前端 CDN 网址跨域访问后端 nodejs 应用负载均衡网址的方法</a> 一文。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="部署前端静态文件到-oss-中">部署前端静态文件到 OSS 中<a href="#部署前端静态文件到-oss-中" class="hash-link" aria-label="Direct link to 部署前端静态文件到 OSS 中" title="Direct link to 部署前端静态文件到 OSS 中" translate="no">​</a></h2>
<p>前端静态文件由 gitlab 自动部署脚本 <code>.gitlab-ci.yml</code> 自动生成并上传到 OSS 中：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">deploy-k8s-frontend:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  stage: deploy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  cache:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    key: frontend</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    paths:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - node_modules/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tags:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - docker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  script:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - rm -f public/bundle.js public/index.html</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - npm run build-web # 这个命令参考自 https://github.com/flyskywhy/noder-react-native</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - if [ -f public/bundle.js ]; then true; else false; fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - export PROJ_GIT_HASH=`git rev-parse --short HEAD`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - sed -i &quot;s/bundle.js/bundle.js?v=$PROJ_GIT_HASH/&quot; public/index.html</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - set +o pipefail</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - yes | /cache/opt/ossutil64 cp -r public/ oss://YourProject-web-release/ -e oss-cn-shanghai.aliyuncs.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     -i $ALIYUN_OSS_ACCESSKEYID -k $ALIYUN_OSS_ACCESSKEYSECRET</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - set -o pipefail</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  only:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - k8s-frontend</span><br></span></code></pre></div></div>
<p>还需对部署了前端文件的 OSS 进行配置：进入 <a href="https://oss.console.aliyun.com" target="_blank" rel="noopener noreferrer">对象存储 OSS</a> 的 <code>YourProject-web-release</code> 的 <code>基础设置 | 静态页面</code> ，设置 <code>默认首页</code> 为 <code>index.html</code> ；如果不想让用户见到 OSS 提供的默认的代替 404 的网页 “This XML file does not appear to have any style information associated with it” ，则还可以设置 <code>默认 404 页</code> 。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="部署后端镜像到-kubernetes-中">部署后端镜像到 Kubernetes 中<a href="#部署后端镜像到-kubernetes-中" class="hash-link" aria-label="Direct link to 部署后端镜像到 Kubernetes 中" title="Direct link to 部署后端镜像到 Kubernetes 中" translate="no">​</a></h2>
<p>阿里云 Kubernetes 的使用费用是比较昂贵的，因为无论是手动组建 Kubernetes 的这篇 <a href="https://www.kubernetes.org.cn/1667.html" target="_blank" rel="noopener noreferrer">在阿里云上部署生产级别Kubernetes集群</a> 文章 ，还是在阿里云里购买 Kubernetes 时的自动配置，所需的 ECS （电脑主机）都至少是 3 台用于 Master 以及 1 台用于真正部署上百个 docker 容器的 Worker 。因为只用 1 台 Worker 体现不出来 Kubernetes 的意义，所以阿里云购买时的标配是 3Master+3Worker 。因为 Master 的配置在购买后无法更改，为了以后性能考虑，只能在购买时一步到位使用它默认的 <code>4核8G(ecs.n4.xlarge)</code> 配置。例如以 6 台 ECS 共 10元/小时 的费用来推算， 3Master+3Worker 的费用为 9万元/年 左右。从 <a href="https://help.aliyun.com/document_detail/69575.html" target="_blank" rel="noopener noreferrer">阿里云 Kubernetes VS 自建 Kubernetes</a> 这篇文章可以看出， Kubernetes 的趋势是慢慢变成云服务商的一个产品，就像数据库、 CDN 等产品那样，因此自己购买 6 台服务器再请专业运维人员（10万/年？）创建、维护、升级 Kubernetes 的性价比低于直接使用阿里云 Kubernetes 。好消息是现在有比阿里云 Kubernetes 性价比更高的产品——阿里云 Serverless Kubernetes ——不用购买 ECS 而是按需付费。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="阿里云-kubernetes">阿里云 Kubernetes<a href="#阿里云-kubernetes" class="hash-link" aria-label="Direct link to 阿里云 Kubernetes" title="Direct link to 阿里云 Kubernetes" translate="no">​</a></h3>
<p><a href="https://help.aliyun.com/document_detail/53752.html" target="_blank" rel="noopener noreferrer">创建Kubernetes集群</a> 时， Pod 和 Service 的网段可以参考如下设置：</p>
<p>Pod 网络 CIDR： 10.0.0.0/16 ，如此设置，就算类似 <a href="https://help.aliyun.com/document_detail" target="_blank" rel="noopener noreferrer">管理专有网络</a> 那里那样存在有系统保留地址，也可以保证每个集群内最多可允许部署 256 台主机。</p>
<p>Service 网络 CIDR： 10.1.0.0/16 ，如此设置比较容易管理，今后如果创建第 2 个集群，那么它的 Pod 和 Service 就分别是</p>
<p>10.2.0.0/16
10.3.0.0/16</p>
<p>如果创建第 3 个集群，那就是</p>
<p>10.4.0.0/16
10.5.0.0/16</p>
<p>以此类推。</p>
<p>参考撰写 <a href="https://code.aliyun.com/CodePipeline/nodejs-demo/blob/master/deployment.yaml" target="_blank" rel="noopener noreferrer">deployment.yaml</a> ，然后参考 <a href="https://help.aliyun.com/document_detail/73980.html" target="_blank" rel="noopener noreferrer">Kubernetes集群中使用阿里云 SLB 实现四层金丝雀发布</a> 图形化部署在阿里云中的工作原理，再参考 <a href="https://kubernetes.io/docs/concepts/services-networking/connect-applications-service/" target="_blank" rel="noopener noreferrer">Connecting Applications with Services</a> 、 <a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/" target="_blank" rel="noopener noreferrer">Deployments</a> 、 <a href="https://kubernetes.io/docs/concepts/services-networking/service/" target="_blank" rel="noopener noreferrer">Services</a> 这些文章编写适合自己项目的 <code>deployment.yaml</code> ，然后在自动部署脚本中配置好 <a href="https://help.aliyun.com/document_detail/53755.html" target="_blank" rel="noopener noreferrer">通过 kubectl 连接 Kubernetes 集群</a> 后（配置的含义见 <a href="https://kubernetes.io/cn/docs/tasks/access-application-cluster/configure-access-multiple-clusters/" target="_blank" rel="noopener noreferrer">配置对多集群的访问</a> 一文），按照 <a href="https://k8smeetup.github.io/docs/concepts/configuration/overview/" target="_blank" rel="noopener noreferrer">配置最佳实践</a> 所说用 <code>kubectl create -f ./deployment.yaml</code> 运行后端镜像，或是不使用 <code>deployment.yaml</code> 而是直接象 <a href="https://kubernetes.io/docs/tasks/access-application-cluster/service-access-application-cluster/" target="_blank" rel="noopener noreferrer">Use a Service to Access an Application in a Cluster</a> 那样用 <code>kubectl run</code> 、 <code>kubectl expose</code> 、 <code>kubectl set</code> 命令行来启动/更新 deployment 和 service （此处可参考 <a href="http://docs.kubernetes.org.cn/70.html" target="_blank" rel="noopener noreferrer">Kubernetes kubectl 与 Docker 命令关系</a> 一文）。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="阿里云-serverless-kubernetes">阿里云 Serverless Kubernetes<a href="#阿里云-serverless-kubernetes" class="hash-link" aria-label="Direct link to 阿里云 Serverless Kubernetes" title="Direct link to 阿里云 Serverless Kubernetes" translate="no">​</a></h3>
<p>在 <a href="https://cs.console.aliyun.com" target="_blank" rel="noopener noreferrer">容器服务 - Kubernetes</a> 中 “创建Serverless Kubernetes” 后， <a href="https://help.aliyun.com/document_detail/71483.html" target="_blank" rel="noopener noreferrer">通过 kubectl 连接 Kubernetes 集群</a> ，然后参考 <a href="https://github.com/AliyunContainerService/serverless-k8s-examples" target="_blank" rel="noopener noreferrer">Serverless Kubernetes Examples</a> 编写适合自己项目的 <code>deployment.yaml</code> 。</p>
<p><a href="https://help.aliyun.com/document_detail/86383.html" target="_blank" rel="noopener noreferrer">使用镜像创建应用</a> 时的 <code>应用配置</code> 页面中的 <code>Init Container</code> 对应 yaml 写法见 <a href="https://kubernetes.io/cn/docs/concepts/workloads/pods/init-containers/" target="_blank" rel="noopener noreferrer">Init 容器</a> ； <code>存活检查</code> 和 <code>就绪检查</code> 对应 yaml 写法见 <a href="https://kubernetes.io/cn/docs/concepts/workloads/pods/pod-lifecycle/" target="_blank" rel="noopener noreferrer">Pod 的生命周期</a> 。</p>
<p>由于更新 service 时会出现 <code>spec.clusterIP: Invalid value: &quot;&quot;: field is immutable</code> 这个已知 k8s 的 BUG ，所以将 <code>deployment.yaml</code> 拆分为 deploy.yaml 和 svc.yaml 会更方便。</p>
<p>示例 deploy.yaml 如下：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: apps/v1beta2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: nodeapp-deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    app: nodeapp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  replicas: 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  selector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    matchLabels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      app: nodeapp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  template:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        app: nodeapp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      # 如果使用的是阿里云以外的私有容器镜像仓库，则需要 imagePullSecrets ，此处 `docker-registrykey-私有容器镜像仓库`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      # 来自于命令 `kubectl create secret docker-registry docker-registrykey-私有容器镜像仓库 --docker-server=私有容器镜像仓库地址 --docker-username=私有容器镜像仓库用户名 --docker-password=私有容器镜像仓库密码`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      # imagePullSecrets:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      #   - name: docker-registrykey-私有容器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - name: nodeapp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          image: registry-vpc.cn-shanghai.aliyuncs.com/你的命名空间/私有容器镜像:latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          imagePullPolicy: Always</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          ports:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - containerPort: 8010</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          # 注意，如果直接在阿里云控制台容器服务更新“部署”会导致环境变量为空</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          # env:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          #   - name: DEMO_GREETING</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          #     value: &quot;Hello from the environment&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          #   - name: NODE_ENV</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          #     valueFrom:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          #       configMapKeyRef:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          #         name: config-some</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          #         key: NODE_ENV</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          #   - name: SERVER_PORT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          #     valueFrom:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          #       secretKeyRef:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          #         name: secret-some</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          #         key: SERVER_PORT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          envFrom:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - configMapRef:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                name: config-some</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - secretRef:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                name: secret-some</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: autoscaling/v2beta1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: HorizontalPodAutoscaler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: nodeapp-autoscaler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  scaleTargetRef:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    apiVersion: apps/v1beta2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kind: Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name: nodeapp-deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  minReplicas: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  maxReplicas: 5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  metrics:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - type: Resource</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    resource:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      name: memory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      targetAverageUtilization: 50</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - type: Resource</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    resource:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      name: cpu</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      targetAverageUtilization: 50</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - type: Pods</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pods:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      metricName: packets-per-second</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      targetAverageValue: 1k</span><br></span></code></pre></div></div>
<p>上面的 <code>nodeapp-autoscaler</code> 参考自 <a href="https://k8smeetup.github.io/docs/tasks/run-application/horizontal-pod-autoscale-walkthrough/" target="_blank" rel="noopener noreferrer">Pod水平自动伸缩（Horizontal Pod Autoscaling）演练</a> 及 <a href="http://blog.51cto.com/ylw6006/2113848" target="_blank" rel="noopener noreferrer">K8S集群基于heapster的HPA测试</a> 。</p>
<p>示例 svc.yaml 如下：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: nodeapp-service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # service.beta.kubernetes.io/alicloud-loadbalancer-protocol-port: &quot;http:80&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 在阿里云“SSL证书”中购买证书后推送到负载均衡，然后在负载均衡页面的证书管理中可以得到下面所需的证书ID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    service.beta.kubernetes.io/alicloud-loadbalancer-cert-id: ${证书ID}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    service.beta.kubernetes.io/alicloud-loadbalancer-protocol-port: &quot;https:443&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 先注释掉本行注解后 kubectl create 创建一个新 SLB 实例，然后为了避免今后 kubectl replace --force</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 或 kubectl delete 时自动删除该 SLB 实例，需要到阿里云控制台负载均衡页面将该 SLB 的“名称”修改掉，</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 将“标签”删除掉，然后 kubectl delete 时就不会删除该 SLB 实例了。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 最后，为了后续一直使用该新建的 SLB 实例比如 lb-bp1hfycf39bbeb019pg7m ，就再同时开启使用下面的注解</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # service.beta.kubernetes.io/alicloud-loadbalancer-id: lb-bp1hfycf39bbeb019pg7m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ports:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - port: 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      name: http-port</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      targetPort: 8010</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      protocol: TCP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - port: 443</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      name: https-port</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      targetPort: 8010</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      protocol: TCP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  selector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    app: nodeapp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type: LoadBalancer</span><br></span></code></pre></div></div>
<p>在唯一一次手工 <code>kubectl create -f svc.yaml</code> 创建一个新 SLB 实例后就按 <code>svc.yaml</code> 中的注释修改该文件以给自动部署脚本调用了。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="让其他阿里云产品能够访问-kubernetes-pod">让其他阿里云产品能够访问 Kubernetes pod<a href="#让其他阿里云产品能够访问-kubernetes-pod" class="hash-link" aria-label="Direct link to 让其他阿里云产品能够访问 Kubernetes pod" title="Direct link to 让其他阿里云产品能够访问 Kubernetes pod" translate="no">​</a></h2>
<p>把专有网络 VPC（Virtual Private Cloud）的 <a href="https://vpcnext.console.aliyun.com/vpc/cn-shanghai/route-tables" target="_blank" rel="noopener noreferrer">路由表</a> 中的 <code>目标网段</code> 添加到相关阿里云产品比如 <a href="https://rdsnext.console.aliyun.com" target="_blank" rel="noopener noreferrer">云数据库RDS</a> 、 <a href="https://mongodb.console.aliyun.com" target="_blank" rel="noopener noreferrer">云数据库MongoDB</a> 等等的白名单中，这样使用着 VPC 地址的 pod 就可以正常访问这些产品了。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="让-kubernetes-pod-能够访问外网">让 Kubernetes pod 能够访问外网<a href="#让-kubernetes-pod-能够访问外网" class="hash-link" aria-label="Direct link to 让 Kubernetes pod 能够访问外网" title="Direct link to 让 Kubernetes pod 能够访问外网" translate="no">​</a></h2>
<p>如果想让 pod 能够访问外网，需要开通 <a href="https://vpcnext.console.aliyun.com/nat/cn-shanghai/nats" target="_blank" rel="noopener noreferrer">NAT网关</a> ，并购买一个 <a href="https://ip.console.aliyun.com" target="_blank" rel="noopener noreferrer">弹性公网IP</a> 绑定到 NAT 的 SNAT 上。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="log">log<a href="#log" class="hash-link" aria-label="Direct link to log" title="Direct link to log" translate="no">​</a></h2>
<p>从这篇文章 <a href="https://blog.csdn.net/zhoushuntian/article/details/79400747" target="_blank" rel="noopener noreferrer">全面提升，阿里云Docker/Kubernetes(K8S) 日志解决方案与选型对比</a> 看，阿里云 logtail 产品 <a href="https://sls.console.aliyun.com" target="_blank" rel="noopener noreferrer">日志服务</a>比 logstash 更适合 k8s 容器环境，而且这样就不用费心去做含有 rsyslogd 程序的 docker 镜像了。</p>
<p>本文主要讲解 Serverless Kubernetes 的 log 方法。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="阿里云-kubernetes-的-log">阿里云 Kubernetes 的 log<a href="#阿里云-kubernetes-的-log" class="hash-link" aria-label="Direct link to 阿里云 Kubernetes 的 log" title="Direct link to 阿里云 Kubernetes 的 log" translate="no">​</a></h3>
<p>详阅 <a href="https://help.aliyun.com/document_detail/66654.html" target="_blank" rel="noopener noreferrer">Kubernetes日志采集</a> ，这里不再赘述。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="阿里云-serverless-kubernetes-的-log">阿里云 Serverless Kubernetes 的 log<a href="#阿里云-serverless-kubernetes-的-log" class="hash-link" aria-label="Direct link to 阿里云 Serverless Kubernetes 的 log" title="Direct link to 阿里云 Serverless Kubernetes 的 log" translate="no">​</a></h3>
<p>因为经阿里云客服工单核实，阿里云日志服务不支持采集 Serverless Kubernetes 的<a href="https://help.aliyun.com/document_detail/66658.html" target="_blank" rel="noopener noreferrer">容器-标准输出</a>，所以这里只能记录下 <a href="https://help.aliyun.com/document_detail/71502.html" target="_blank" rel="noopener noreferrer">通过阿里云日志服务采集日志</a> 对文本 <a href="https://help.aliyun.com/document_detail/28981.html" target="_blank" rel="noopener noreferrer">采集方式</a> 的实践过程。</p>
<p>步骤 1 <a href="https://help.aliyun.com/document_detail/48984.html" target="_blank" rel="noopener noreferrer">操作Project</a> 创建 YourProject 项目。</p>
<p>步骤 2 <a href="https://help.aliyun.com/document_detail/48990.html" target="_blank" rel="noopener noreferrer">操作Logstore</a> 创建 dev-access 日志库。</p>
<p>步骤 3 以机器组名称 dev <a href="https://help.aliyun.com/document_detail/28966.html" target="_blank" rel="noopener noreferrer">创建机器组</a> ，并将用户自定义标识设为 YourProject-dev ，该用户自定义标识后面将会被配置到 YAML 环境变量 ALIYUN_LOGTAIL_USER_DEFINED_ID 中。</p>
<p>步骤 4 创建 Logtail 配置，数据类型选择 <code>Docker文件</code> ；下一步，配置名称填写 <code>dev-access</code> ，日志路径填写 <code>/ecilogs</code> 和 <code>access.log</code> ，模式可以先选择 <code>极简模式</code> 使得日志内容展示原始的一行 log ，如果你的 log 是 JSON 格式的话，稍后可以再回来修改为 <code>JSON模式</code> ，然后你就会看到新的日志内容变成了多行的 kev-value 格式；下一步，应用到 dev 机器组。</p>
<p>步骤 5 在上面的 deploy.yaml 中的 spec.template.spec 里修改为如下配置：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">      containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - name: ilogtail</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          image: registry.cn-hangzhou.aliyuncs.com/acs/ilogtail:0.13.4-eb42407</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          env:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - name: ALIYUN_REGION_ID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              value: ${https://help.aliyun.com/document_detail/40654.html 中描述的 k8s 集群所在的地域ID}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - name: ALIYUN_LOGTAIL_USER_ID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              value: &quot;${https://account.console.aliyun.com 中所示的阿里云账号ID（不是账号名，而且因为ID是一串数字，而这里需要的是字符串，所以记得加双引号）}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - name: ALIYUN_LOGTAIL_USER_DEFINED_ID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              value: YourProject-dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          volumeMounts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - name: app-log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              mountPath: /ecilogs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              readOnly: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - name: nodeapp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - secretRef:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                name: secret-some</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          volumeMounts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - name: app-log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              mountPath: /log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      volumes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - name: app-log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          emptyDir: {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>现在，在日志库中点击 dev-access 的 <code>查询</code> ，就可以看到日志内容了。</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/../g/i主观的体验方式/t快乐的体验/电信/Tool/配置管理/Git/GitLab自动部署nodejs应用到阿里云Kubernetes集群中.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/g/docs/i主观的体验方式/t快乐的体验/电信/Tool/配置管理/Git/GitLab使用详解"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">GitLab使用详解</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/g/docs/i主观的体验方式/t快乐的体验/电信/Tool/配置管理/Git/Git最简培训"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Git最简培训</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#在阿里云中开启容器仓库" class="table-of-contents__link toc-highlight">在阿里云中开启容器仓库</a></li><li><a href="#用-docker-生成后端镜像" class="table-of-contents__link toc-highlight">用 docker 生成后端镜像</a></li><li><a href="#部署前端静态文件到-oss-中" class="table-of-contents__link toc-highlight">部署前端静态文件到 OSS 中</a></li><li><a href="#部署后端镜像到-kubernetes-中" class="table-of-contents__link toc-highlight">部署后端镜像到 Kubernetes 中</a><ul><li><a href="#阿里云-kubernetes" class="table-of-contents__link toc-highlight">阿里云 Kubernetes</a></li><li><a href="#阿里云-serverless-kubernetes" class="table-of-contents__link toc-highlight">阿里云 Serverless Kubernetes</a></li></ul></li><li><a href="#让其他阿里云产品能够访问-kubernetes-pod" class="table-of-contents__link toc-highlight">让其他阿里云产品能够访问 Kubernetes pod</a></li><li><a href="#让-kubernetes-pod-能够访问外网" class="table-of-contents__link toc-highlight">让 Kubernetes pod 能够访问外网</a></li><li><a href="#log" class="table-of-contents__link toc-highlight">log</a><ul><li><a href="#阿里云-kubernetes-的-log" class="table-of-contents__link toc-highlight">阿里云 Kubernetes 的 log</a></li><li><a href="#阿里云-serverless-kubernetes-的-log" class="table-of-contents__link toc-highlight">阿里云 Serverless Kubernetes 的 log</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/g/docs">Docs</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://x.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">X<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/g/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/flyskywhy/g" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>