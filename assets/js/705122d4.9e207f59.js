"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[7168],{4452:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>r,contentTitle:()=>l,default:()=>_,frontMatter:()=>o,metadata:()=>i,toc:()=>c});const i=JSON.parse('{"id":"i\u4e3b\u89c2\u7684\u4f53\u9a8c\u65b9\u5f0f/t\u5feb\u4e50\u7684\u4f53\u9a8c/\u7535\u4fe1/Net/\u7269\u8054\u7f51/SmartLiving/AliSmartLiving\u4f7f\u7528\u8be6\u89e3","title":"AliSmartLiving\u4f7f\u7528\u8be6\u89e3","description":"Li Zheng flyskywhy@gmail.com","source":"@site/../g/i\u4e3b\u89c2\u7684\u4f53\u9a8c\u65b9\u5f0f/t\u5feb\u4e50\u7684\u4f53\u9a8c/\u7535\u4fe1/Net/\u7269\u8054\u7f51/SmartLiving/AliSmartLiving\u4f7f\u7528\u8be6\u89e3.md","sourceDirName":"i\u4e3b\u89c2\u7684\u4f53\u9a8c\u65b9\u5f0f/t\u5feb\u4e50\u7684\u4f53\u9a8c/\u7535\u4fe1/Net/\u7269\u8054\u7f51/SmartLiving","slug":"/i\u4e3b\u89c2\u7684\u4f53\u9a8c\u65b9\u5f0f/t\u5feb\u4e50\u7684\u4f53\u9a8c/\u7535\u4fe1/Net/\u7269\u8054\u7f51/SmartLiving/AliSmartLiving\u4f7f\u7528\u8be6\u89e3","permalink":"/g/docs/i\u4e3b\u89c2\u7684\u4f53\u9a8c\u65b9\u5f0f/t\u5feb\u4e50\u7684\u4f53\u9a8c/\u7535\u4fe1/Net/\u7269\u8054\u7f51/SmartLiving/AliSmartLiving\u4f7f\u7528\u8be6\u89e3","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"\u65b0\u589e\u57df\u540d\u81ea\u52a8\u8df3\u8f6c\u5230\u539f\u57df\u540d\u66a8\u914d\u5408nginx\u914d\u7f6e\u6587\u4ef6\u7406\u89e3\u963f\u91cc\u4e91\u754c\u9762\u76f8\u5173\u8bbe\u7f6e","permalink":"/g/docs/i\u4e3b\u89c2\u7684\u4f53\u9a8c\u65b9\u5f0f/t\u5feb\u4e50\u7684\u4f53\u9a8c/\u7535\u4fe1/Net/\u4e91/Aliyun/\u65b0\u589e\u57df\u540d\u81ea\u52a8\u8df3\u8f6c\u5230\u539f\u57df\u540d\u66a8\u914d\u5408nginx\u914d\u7f6e\u6587\u4ef6\u7406\u89e3\u963f\u91cc\u4e91\u754c\u9762\u76f8\u5173\u8bbe\u7f6e"},"next":{"title":"BoneEngine\u4f7f\u7528\u8be6\u89e3","permalink":"/g/docs/i\u4e3b\u89c2\u7684\u4f53\u9a8c\u65b9\u5f0f/t\u5feb\u4e50\u7684\u4f53\u9a8c/\u7535\u4fe1/Os/AliOsThings/BoneEngine\u4f7f\u7528\u8be6\u89e3"}}');var t=s(4848),a=s(8453);const o={},l="Ali SmartLiving \u4f7f\u7528\u8be6\u89e3",r={},c=[{value:"\u5b89\u88c5\u8bbe\u5907\u7aef\u7f16\u8bd1\u73af\u5883",id:"\u5b89\u88c5\u8bbe\u5907\u7aef\u7f16\u8bd1\u73af\u5883",level:2},{value:"\u5b89\u88c5 python \u548c aos",id:"\u5b89\u88c5-python-\u548c-aos",level:3},{value:"\u8ba9 python \u811a\u672c\u8fd0\u884c\u5728 python2 \u4e2d",id:"\u8ba9-python-\u811a\u672c\u8fd0\u884c\u5728-python2-\u4e2d",level:3},{value:"\u8ba9 aos \u8fd0\u884c\u5728 python3 \u4e2d",id:"\u8ba9-aos-\u8fd0\u884c\u5728-python3-\u4e2d",level:3},{value:"\u5176\u5b83",id:"\u5176\u5b83",level:3},{value:"\u8bbe\u5907\u7aef\u7f16\u8bd1 Ali SmartLiving",id:"\u8bbe\u5907\u7aef\u7f16\u8bd1-ali-smartliving",level:2},{value:"\u8bbe\u5907\u7aef\u6dfb\u52a0 WebSocket Server \u652f\u6301",id:"\u8bbe\u5907\u7aef\u6dfb\u52a0-websocket-server-\u652f\u6301",level:2},{value:"\u6dfb\u52a0 libwebsockets \u7684\u7b2c 1 \u6b65: \u7b80\u5355\u590d\u5236 https://github.com/warmcat/libwebsockets/tree/v2.4.1/lib/ \u6574\u4e2a\u76ee\u5f55",id:"\u6dfb\u52a0-libwebsockets-\u7684\u7b2c-1-\u6b65-\u7b80\u5355\u590d\u5236-httpsgithubcomwarmcatlibwebsocketstreev241lib-\u6574\u4e2a\u76ee\u5f55",level:3},{value:"\u6dfb\u52a0 libwebsockets \u7684\u7b2c 2 \u6b65: \u590d\u5236\u963f\u91cc\u5b98\u65b9\u7684\u9002\u914d\u4ee3\u7801\uff0c\u6765\u81ea https://github.com/alibaba/AliOS-Things/commit/9326fc864c282e6c3209b2fd00082b451effa54e",id:"\u6dfb\u52a0-libwebsockets-\u7684\u7b2c-2-\u6b65-\u590d\u5236\u963f\u91cc\u5b98\u65b9\u7684\u9002\u914d\u4ee3\u7801\u6765\u81ea-httpsgithubcomalibabaalios-thingscommit9326fc864c282e6c3209b2fd00082b451effa54e",level:3},{value:"\u6dfb\u52a0 libwebsockets \u7684\u7b2c 3 \u6b65: \u5728\u4f60\u81ea\u5df1\u7684\u4ee3\u7801\u4e2d\u4f7f\u7528 libwebsockets \u5e76\u5f00\u542f websocket server",id:"\u6dfb\u52a0-libwebsockets-\u7684\u7b2c-3-\u6b65-\u5728\u4f60\u81ea\u5df1\u7684\u4ee3\u7801\u4e2d\u4f7f\u7528-libwebsockets-\u5e76\u5f00\u542f-websocket-server",level:3},{value:"Living_SDK/framework/libwebsockets/libwebsockets.mk",id:"living_sdkframeworklibwebsocketslibwebsocketsmk",level:4},{value:"Living_SDK/framework/libwebsockets/lws_config.h",id:"living_sdkframeworklibwebsocketslws_configh",level:4},{value:"Living_SDK/framework/libwebsockets/mbedtls_wrapper/mbedtls_wrapper.mk",id:"living_sdkframeworklibwebsocketsmbedtls_wrappermbedtls_wrappermk",level:4},{value:"Living_SDK/framework/libwebsockets/sync.py",id:"living_sdkframeworklibwebsocketssyncpy",level:4},{value:"Products/example/YourAPP/YourAPP.mk",id:"productsexampleyourappyourappmk",level:4},{value:"Products/example/YourAPP/makefile",id:"productsexampleyourappmakefile",level:4},{value:"Products/example/YourAPP/softap.c",id:"productsexampleyourappsoftapc",level:4},{value:"tools/bk7231udevkitc.sh",id:"toolsbk7231udevkitcsh",level:4}];function p(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",p:"p",pre:"pre",...(0,a.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(n.p,{children:["Li Zheng ",(0,t.jsx)(n.a,{href:"mailto:flyskywhy@gmail.com",children:"flyskywhy@gmail.com"})]}),"\n",(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"ali-smartliving-\u4f7f\u7528\u8be6\u89e3",children:"Ali SmartLiving \u4f7f\u7528\u8be6\u89e3"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.a,{href:"https://living.aliyun.com/",children:"\u963f\u91cc\u4e91\u751f\u6d3b\u7269\u8054\u7f51\u5e73\u53f0"})}),"\n",(0,t.jsx)(n.h2,{id:"\u5b89\u88c5\u8bbe\u5907\u7aef\u7f16\u8bd1\u73af\u5883",children:"\u5b89\u88c5\u8bbe\u5907\u7aef\u7f16\u8bd1\u73af\u5883"}),"\n",(0,t.jsx)(n.p,{children:"\u7531\u4e8e Ubuntu \u7528\u6765\u7f16\u8bd1 alios \u7684\u5de5\u5177 aos \u53ea\u80fd\u901a\u8fc7 python3 \u76f8\u5173\u7684\u7ec4\u4ef6 python3-pip \u6765\u5b89\u88c5\uff0c\u800c ali-smartliving-device-alios-things \u4e2d\u4e00\u4e9b\u5b98\u65b9\u63d0\u4f9b\u7684 python \u811a\u672c\u4ecd\u7136\u662f python2 \u8bed\u6cd5\u7684\uff0c\u6240\u4ee5\u9700\u8981\u5982\u4e0b\u7f57\u55e6\u7684\u65b9\u6cd5\u6765\u5b89\u88c5\u7f16\u8bd1\u73af\u5883\uff0c\u800c\u975e\u4ec5\u4ec5\u53ea\u662f\u5b89\u88c5 aos \u5373\u53ef\u3002"}),"\n",(0,t.jsx)(n.h3,{id:"\u5b89\u88c5-python-\u548c-aos",children:"\u5b89\u88c5 python \u548c aos"}),"\n",(0,t.jsx)(n.p,{children:"sudo apt-get install python2 python3 python3-pip\npip3 install aos-cube"}),"\n",(0,t.jsx)(n.h3,{id:"\u8ba9-python-\u811a\u672c\u8fd0\u884c\u5728-python2-\u4e2d",children:"\u8ba9 python \u811a\u672c\u8fd0\u884c\u5728 python2 \u4e2d"}),"\n",(0,t.jsx)(n.p,{children:"\u5982\u679c\u901a\u8fc7\u5982\u4e0b\u547d\u4ee4"}),"\n",(0,t.jsx)(n.p,{children:"ls -l /usr/bin/python"}),"\n",(0,t.jsx)(n.p,{children:"\u53d1\u73b0"}),"\n",(0,t.jsx)(n.p,{children:"/usr/bin/python -> python3"}),"\n",(0,t.jsx)(n.p,{children:"\u5219"}),"\n",(0,t.jsx)(n.p,{children:"cd /usr/bin\nsudo ln -f -s python2 python"}),"\n",(0,t.jsxs)(n.p,{children:["\u5426\u5219\u7f16\u8bd1\u65f6\u4f1a\u51fa\u73b0 ",(0,t.jsx)(n.code,{children:"NameError: name 'file' is not defined"})," \u7b49\u9519\u8bef\u3002"]}),"\n",(0,t.jsx)(n.h3,{id:"\u8ba9-aos-\u8fd0\u884c\u5728-python3-\u4e2d",children:"\u8ba9 aos \u8fd0\u884c\u5728 python3 \u4e2d"}),"\n",(0,t.jsxs)(n.p,{children:["\u7528\u6587\u672c\u7f16\u8f91\u5668\u6253\u5f00 ",(0,t.jsx)(n.code,{children:"~/.local/bin/aos"})," \uff0c\u786e\u4fdd\u7b2c\u4e00\u884c\u662f ",(0,t.jsx)(n.code,{children:"#!/usr/bin/python3"})," \u3002"]}),"\n",(0,t.jsxs)(n.p,{children:["\u5426\u5219\u7f16\u8bd1\u65f6\u4f1a\u51fa\u73b0 ",(0,t.jsx)(n.code,{children:"ImportError: No module named aos.__main__"})," \u9519\u8bef\u3002"]}),"\n",(0,t.jsx)(n.h3,{id:"\u5176\u5b83",children:"\u5176\u5b83"}),"\n",(0,t.jsxs)(n.p,{children:["\u6211\u4e5f\u66fe\u60f3\u8981\u901a\u8fc7\u7b80\u5355\u5c06\u811a\u672c\u4ece python2 \u5347\u7ea7\u5230 python3 \u8bed\u6cd5\u6765\u89e3\u51b3 ",(0,t.jsx)(n.code,{children:"NameError: name 'file' is not defined"})," \u7b49\u9519\u8bef\uff0c\u4f46\u662f\u53c8\u5e26\u6765\u4e86\u5176\u5b83\u8bed\u6cd5\u95ee\u9898\uff0c\u8fd9\u5df2\u7ecf\u4e0d\u662f\u6211\u4eec\u800c\u662f sdk \u63d0\u4f9b\u8005\u9700\u8981\u518d\u82b1\u65f6\u95f4\u5728\u4e0a\u9762\u4e86\uff0c\u8fd8\u662f\u5982\u4e0a\u6240\u8ff0\u5b89\u88c5 python2 \u5427\u3002\u4e4b\u524d\u542c\u8bf4 python 2 \u548c 3 \u4e0d\u517c\u5bb9\u56e0\u800c\u6211\u4e00\u76f4\u62d2\u7edd\u6df1\u5165\u5b66\u4e60\u4f7f\u7528 python \uff0c\u679c\u7136 python \u5c31\u662f\u5dee\u52b2\u554a\uff0c\u5f00\u6e90\u4e16\u754c\u8fd8\u4e0d\u5982\u5c06\u7528\u5230 python \u7684\u5730\u65b9\u90fd\u5207\u6362\u4e3a nodejs \u5462\u3002"]}),"\n",(0,t.jsxs)(n.p,{children:["\u6ce8\uff0c\u4e0a\u8ff0\u7b80\u5355\u5c06 python2 \u7684 ",(0,t.jsx)(n.code,{children:"file"})," \u6539\u4e3a python3 \u7684 ",(0,t.jsx)(n.code,{children:"open"})," \u540e\uff0c\u8fd8\u4f1a\u51fa\u73b0\u5982\u4e0b\u62a5\u9519\u4fe1\u606f\uff1a"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'    Traceback (most recent call last):\n      File "tools/bk7231u/gen_firmware_img_uart0.py", line 39, in <module>\n        pack_image(sys.argv[1], sys.argv[2])\n      File "tools/bk7231u/gen_firmware_img_uart0.py", line 30, in pack_image\n        f.write("\\xff")\n    TypeError: a bytes-like object is required, not \'str\'\n'})}),"\n",(0,t.jsx)(n.h2,{id:"\u8bbe\u5907\u7aef\u7f16\u8bd1-ali-smartliving",children:"\u8bbe\u5907\u7aef\u7f16\u8bd1 Ali SmartLiving"}),"\n",(0,t.jsxs)(n.p,{children:["\u53c2\u89c1 ",(0,t.jsx)(n.code,{children:"ali-smartliving-device-alios-things/README.md"})," \u4e2d ",(0,t.jsx)(n.code,{children:"build.sh"})," \u7684\u4f7f\u7528\u65b9\u6cd5\u3002"]}),"\n",(0,t.jsx)(n.h2,{id:"\u8bbe\u5907\u7aef\u6dfb\u52a0-websocket-server-\u652f\u6301",children:"\u8bbe\u5907\u7aef\u6dfb\u52a0 WebSocket Server \u652f\u6301"}),"\n",(0,t.jsx)(n.p,{children:"\u6dfb\u52a0 WebSocket Server \u4e4b\u540e\uff0c\u5c31\u53ef\u4ee5\u914d\u5408\u6a21\u5757\u5382\u5546\uff08\u4e0d\u662f\u963f\u91cc\u5b98\u65b9\uff09\u7684 WiFi \u70ed\u70b9\u4ee3\u7801\uff0c\u8ba9 APP \u76f4\u8fde\u63a7\u5236\u8bbe\u5907\uff0c\u800c\u65e0\u9700\nAli SmartLiving \u5b98\u65b9\u7684\u626b\u63cf\u3001\u914d\u7f51\u3001\u63a7\u5236\u8bbe\u5907\u6d41\u7a0b\uff0c\u65e0\u9700\u70e7\u5f55\u4ea7\u54c1 id \u7b49\u4e09\u5143\u7ec4\u4fe1\u606f\uff0c\u56e0\u6b64\u4e5f\u5c31\u65e0\u9700\u5411\u963f\u91cc\u8d2d\u4e70\u8fd9\u4e9b\u4e09\u5143\u7ec4\uff08\u56e0\u4e3a\u76f4\u8fde\u6a21\u5f0f\u4e0d\u8d70\u963f\u91cc\u4e91\u751f\u6d3b\u7269\u8054\u7f51\u5e73\u53f0\u4e5f\u80fd\u7528\uff09\uff0c\u751a\u81f3\u65e0\u9700\u70e7\u5f55\u53ef\u80fd\u4e5f\u8981\u82b1\u94b1\u8d2d\u4e70\u7684 mac \u5730\u5740\uff01\u4e4b\u6240\u4ee5\u4f7f\u7528 WebSocket \u800c\u975e\u4f20\u7edf\u7684 Socket \uff0c\u662f\u56e0\u4e3a\u6d4f\u89c8\u5668\u4e0d\u652f\u6301\u521b\u5efa Socket \u8fde\u63a5\uff0c\u800c\u4f7f\u7528 WebSocket \u7684\u8bdd\uff0c(react-native \u548c react-native-web \u540c\u4e00\u5957\u4ee3\u7801\u7f16\u5199\u7684)\u624b\u673a\u7248\u6216\u7f51\u9875\u7248 APP \u90fd\u53ef\u4ee5\u8fdb\u884c\u8fde\u63a5\u3002"}),"\n",(0,t.jsxs)(n.p,{children:["\u4e4b\u6240\u4ee5\u5728 ",(0,t.jsx)(n.a,{href:"https://en.wikipedia.org/wiki/Comparison_of_WebSocket_implementations",children:"Comparison of WebSocket implementations"})," \u4e2d\u9009\u62e9 libwebsockets \u800c\u975e noPoll \u7b49 C \u8bed\u8a00 WebSocket \u5b9e\u73b0\uff0c\u662f\u56e0\u4e3a Ali SmartLiving \u6240\u4f9d\u8d56\u7684 ",(0,t.jsx)(n.a,{href:"https://github.com/alibaba/AliOS-Things",children:"AliOS-Things"})," \u66fe\u7ecf\u91c7\u7528\u8fc7\u4e00\u6bb5\u65f6\u95f4\u7684 libwebsockets \uff0c\u6240\u4ee5\u53ef\u4ee5\u53c2\u8003\u5f53\u65f6\u7684\u963f\u91cc\u5b98\u65b9\u9002\u914d\u4ee3\u7801\u3002"]}),"\n",(0,t.jsx)(n.p,{children:"\u4ee5\u4e0b\u5217\u51fa\u9488\u5bf9 Ali SmartLiving \u7684\u98de\u71d5 SDK 1.6.0 \u6dfb\u52a0 WebSocket Server \u652f\u6301\u7684\u65b9\u6cd5"}),"\n",(0,t.jsxs)(n.h3,{id:"\u6dfb\u52a0-libwebsockets-\u7684\u7b2c-1-\u6b65-\u7b80\u5355\u590d\u5236-httpsgithubcomwarmcatlibwebsocketstreev241lib-\u6574\u4e2a\u76ee\u5f55",children:["\u6dfb\u52a0 libwebsockets \u7684\u7b2c 1 \u6b65: \u7b80\u5355\u590d\u5236 ",(0,t.jsx)(n.a,{href:"https://github.com/warmcat/libwebsockets/tree/v2.4.1/lib/",children:"https://github.com/warmcat/libwebsockets/tree/v2.4.1/lib/"})," \u6574\u4e2a\u76ee\u5f55"]}),"\n",(0,t.jsxs)(n.p,{children:["\u5c06\u8be5 ",(0,t.jsx)(n.code,{children:"lib/"})," \u76ee\u5f55\u590d\u5236\u4e3a ",(0,t.jsx)(n.code,{children:"Living_SDK/framework/libwebsockets/"})," \u3002\u4e4b\u6240\u4ee5\u9009\u62e9 ",(0,t.jsx)(n.code,{children:"v2.4.1"})," \uff0c\u662f\u56e0\u4e3a\u7ecf\u6bd4\u8f83\u53d1\u73b0\uff0c\u963f\u91cc\u5b98\u65b9\u66fe\u7ecf\u9002\u914d\u8fc7\u7684 libwebsockets \u4ee3\u7801\u5c31\u662f\u8fd9\u4e2a\u7248\u672c\u7684\u3002"]}),"\n",(0,t.jsxs)(n.h3,{id:"\u6dfb\u52a0-libwebsockets-\u7684\u7b2c-2-\u6b65-\u590d\u5236\u963f\u91cc\u5b98\u65b9\u7684\u9002\u914d\u4ee3\u7801\u6765\u81ea-httpsgithubcomalibabaalios-thingscommit9326fc864c282e6c3209b2fd00082b451effa54e",children:["\u6dfb\u52a0 libwebsockets \u7684\u7b2c 2 \u6b65: \u590d\u5236\u963f\u91cc\u5b98\u65b9\u7684\u9002\u914d\u4ee3\u7801\uff0c\u6765\u81ea ",(0,t.jsx)(n.a,{href:"https://github.com/alibaba/AliOS-Things/commit/9326fc864c282e6c3209b2fd00082b451effa54e",children:"https://github.com/alibaba/AliOS-Things/commit/9326fc864c282e6c3209b2fd00082b451effa54e"})]}),"\n",(0,t.jsxs)(n.p,{children:["\u5c06\u8be5\u63d0\u4ea4\u70b9\u4e2d\u65b0\u589e\u7684\u6587\u4ef6\u590d\u5236\u5230 ",(0,t.jsx)(n.code,{children:"Living_SDK/framework/libwebsockets/"})," \u4e2d\u3002"]}),"\n",(0,t.jsx)(n.h3,{id:"\u6dfb\u52a0-libwebsockets-\u7684\u7b2c-3-\u6b65-\u5728\u4f60\u81ea\u5df1\u7684\u4ee3\u7801\u4e2d\u4f7f\u7528-libwebsockets-\u5e76\u5f00\u542f-websocket-server",children:"\u6dfb\u52a0 libwebsockets \u7684\u7b2c 3 \u6b65: \u5728\u4f60\u81ea\u5df1\u7684\u4ee3\u7801\u4e2d\u4f7f\u7528 libwebsockets \u5e76\u5f00\u542f websocket server"}),"\n",(0,t.jsx)(n.h4,{id:"living_sdkframeworklibwebsocketslibwebsocketsmk",children:"Living_SDK/framework/libwebsockets/libwebsockets.mk"}),"\n",(0,t.jsxs)(n.p,{children:["\u5c06 ",(0,t.jsx)(n.code,{children:"Living_SDK/framework/libwebsockets/websockets.mk"})," \u91cd\u547d\u540d\u4e3a ",(0,t.jsx)(n.code,{children:"libwebsockets.mk"})," \uff0c\u5e76\u505a\u5982\u4e0b\u4fee\u6539"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"@@ -1,17 +1,16 @@\n-NAME := websockets\n+NAME := libwebsockets\n\n GLOBAL_CFLAGS += -Wall\n\n-$(NAME)_COMPONENTS := mbedtls alicrypto connectivity.websockets.mbedtls_wrapper\n+$(NAME)_COMPONENTS := imbedtls alicrypto libwebsockets.mbedtls_wrapper\n\n $(NAME)_SOURCES := handshake.c libwebsockets.c service.c pollfd.c output.c context.c alloc.c header.c ssl.c\n\n $(NAME)_SOURCES += misc/base64-decode.c misc/lws-ring.c misc/lws-genhash.c misc/sha-1.c\n\n-#$(NAME)_SOURCES += server/ranges.c server/server.c server/parsers.c server/ssl-server.c server/server-handshake.c\n-$(NAME)_SOURCES += server/parsers.c\n+$(NAME)_SOURCES += server/server.c server/parsers.c server/ssl-server.c server/server-handshake.c\n\n-$(NAME)_SOURCES += client/client.c client/client-handshake.c client/client-parser.c client/ssl-client.c\n+# $(NAME)_SOURCES += client/client.c client/client-handshake.c client/client-parser.c client/ssl-client.c\n"})}),"\n",(0,t.jsx)(n.h4,{id:"living_sdkframeworklibwebsocketslws_configh",children:"Living_SDK/framework/libwebsockets/lws_config.h"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"@@ -75,10 +75,10 @@\n #define LWS_NO_DAEMONIZE\n\n /* Build without server support */\n-#define LWS_NO_SERVER\n+/* #undef LWS_NO_SERVER */\n\n /* Build without client support */\n-/* #undef LWS_NO_CLIENT */\n+#define LWS_NO_CLIENT\n"})}),"\n",(0,t.jsx)(n.h4,{id:"living_sdkframeworklibwebsocketsmbedtls_wrappermbedtls_wrappermk",children:"Living_SDK/framework/libwebsockets/mbedtls_wrapper/mbedtls_wrapper.mk"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"-$(NAME)_COMPONENTS := mbedtls alicrypto\n+$(NAME)_COMPONENTS := imbedtls alicrypto\n"})}),"\n",(0,t.jsx)(n.h4,{id:"living_sdkframeworklibwebsocketssyncpy",children:"Living_SDK/framework/libwebsockets/sync.py"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"-sync = False #do not sync this module\n+# sync = False #do not sync this module\n"})}),"\n",(0,t.jsx)(n.h4,{id:"productsexampleyourappyourappmk",children:"Products/example/YourAPP/YourAPP.mk"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:" $(NAME)_COMPONENTS += framework/protocol/linkkit/sdk \\\n                       framework/protocol/linkkit/hal \\\n                       framework/netmgr \\\n+                      framework/libwebsockets \\\n                       framework/common \\\n                       utility/cjson \\\n                       framework/uOTA\n"})}),"\n",(0,t.jsx)(n.h4,{id:"productsexampleyourappmakefile",children:"Products/example/YourAPP/makefile"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"@@ -14,6 +14,9 @@ INCLUDE      = $(INCLUDE_PATH)/ \\\n                -I$(PWD)/../../../prebuild/include/platform/arch/arm/armv7m/gcc/m4 \\\n                -I$(PWD)/../../../prebuild/include/board/$(BOARD) \\\n                -I$(PWD)/../../../Living_SDK/kernel/protocols/net/include \\\n+               -I$(PWD)/../../../Living_SDK/security/imbedtls/include \\\n+               -I$(PWD)/../../../Living_SDK/framework/libwebsockets \\\n+               -I$(PWD)/../../../Living_SDK/framework/libwebsockets/mbedtls_wrapper/include \\\n                -I$(PWD)/../../../Living_SDK/platform/mcu/bk7231u/beken/alios/entry \\\n                -I$(PWD)/../../../Living_SDK/platform/mcu/bk7231u/beken/alios/lwip-2.0.2/port \\\n                -I$(PWD)/../../../Living_SDK/platform/mcu/bk7231u/beken/common \\\n"})}),"\n",(0,t.jsx)(n.h4,{id:"productsexampleyourappsoftapc",children:"Products/example/YourAPP/softap.c"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'#include <lwip/sockets.h>\n\n#include <libwebsockets.h>\n#define LWS_PLUGIN_STATIC\n\n#include "aos/kv.h"\n\n#define SOCK_IN_PORT 7681\n\ntypedef void*(*property_rw_func)(const char *request, const int request_len);\nproperty_rw_func softap_property_setting_cb = 0;\n\nstatic unsigned char softap_flag = 0;\nstatic bool softap_launch = false;\nstatic bool connected = false;\n\nvoid SetSoftApPropertySettingHandle(void* cb)\n{\n    if(cb != NULL){\n        softap_property_setting_cb = cb;\n    }\n}\n\n#define MAX_RX_MSG_LEN 200\n#define MAX_TX_MSG_LEN 332\nstruct msg {\n    char payload[LWS_PRE + MAX_TX_MSG_LEN];\n    size_t len;\n};\n\nstruct msg amsg; /* the one pending message... */\n\nstruct per_session_data__minimal {\n    struct per_session_data__minimal *pss_list;\n    struct lws *wsi;\n};\n\nstruct per_session_data__minimal *websocket_pss_list; /* linked-list of live pss*/\n\nvoid softap_msg_response_handle(char* msg, int len)\n{\n    LOG("[SoftAP] tx len: %d, msg: %s", len, msg);\n    if (len > MAX_TX_MSG_LEN) {\n        LOG("[SoftAP] tx msg is to big");\n        return;\n    }\n\n    amsg.len = len;\n    memcpy((char *)amsg.payload + LWS_PRE, msg, len);\n\n    lws_start_foreach_llp(struct per_session_data__minimal **,\n                  ppss, websocket_pss_list) {\n        lws_callback_on_writable((*ppss)->wsi);\n    } lws_end_foreach_llp(ppss, pss_list);\n}\n\nstatic void softap_property_setting_handle(const char* buffer, int len)\n{\n    if(softap_property_setting_cb != NULL){\n        softap_property_setting_cb(buffer, len);\n    }\n}\n\nbool softap_isstart(void){\n    return softap_launch;\n}\n\nvoid softap_task_stop(void){\n    softap_launch = false;\n}\n\nvoid softap_task_start(void){\n    softap_launch = true;\n}\n\n#define lws_ll_fwd_insert(\\\n    ___new_object,  /* pointer to new object */ \\\n    ___m_list,  /* member for next list object ptr */ \\\n    ___list_head    /* list head */ \\\n        ) {\\\n        ___new_object->___m_list = ___list_head; \\\n        ___list_head = ___new_object; \\\n    }\n\n#define lws_ll_fwd_remove(\\\n    ___type,    /* type of listed object */ \\\n    ___m_list,  /* member for next list object ptr */ \\\n    ___target,  /* object to remove from list */ \\\n    ___list_head    /* list head */ \\\n    ) { \\\n                lws_start_foreach_llp(___type **, ___ppss, ___list_head) { \\\n                        if (*___ppss == ___target) { \\\n                                *___ppss = ___target->___m_list; \\\n                                break; \\\n                        } \\\n                } lws_end_foreach_llp(___ppss, ___m_list); \\\n    }\n\n// ref to\n// https://libwebsockets.org/lws-api-doc-v2.4-stable/html/md_READMEs_README_8coding.html\n// https://github.com/warmcat/libwebsockets/blob/main/minimal-examples-lowlevel/ws-server/minimal-ws-server/protocol_lws_minimal.c\nstatic int\ncallback_smartliving(struct lws *wsi, enum lws_callback_reasons reason,\n            void *user, void *in, size_t len)\n{\n    struct per_session_data__minimal *pss =\n            (struct per_session_data__minimal *)user;\n\n    int m;\n\n    LOGD("LWS_CALLBACK %d", reason);\n    switch (reason) {\n    case LWS_CALLBACK_PROTOCOL_INIT:\n        break;\n\n    case LWS_CALLBACK_ESTABLISHED:\n        /* add ourselves to the list of live pss held in the global variable */\n        lws_ll_fwd_insert(pss, pss_list, websocket_pss_list);\n        pss->wsi = wsi;\n\n        if (connected) {\n            // maybe your APP only allow 1 connection?\n            // TODO: allow more than 1 connection?\n            LOG("only one connection is allowed\\n");\n            lws_close_reason(wsi, LWS_CLOSE_STATUS_UNEXPECTED_CONDITION,\n                     (unsigned char *)"only one", 5);\n            return -1;\n        } else {\n            connected = true;\n            LOG("websocket established\\n");\n        }\n        break;\n\n    case LWS_CALLBACK_CLOSED:\n        /* remove our closing pss from the list of live pss */\n        lws_ll_fwd_remove(struct per_session_data__minimal, pss_list,\n                  pss, websocket_pss_list);\n\n        connected = false;\n        LOG("websocket closed\\n");\n        break;\n\n    case LWS_CALLBACK_SERVER_WRITEABLE:\n        if (!amsg.payload)\n            break;\n\n        /* notice we allowed for LWS_PRE in the payload already */\n        m = lws_write(wsi, ((unsigned char *)amsg.payload) +\n                  LWS_PRE, amsg.len, LWS_WRITE_TEXT);\n        LOG("lws_write %s\\n", (unsigned char *)amsg.payload + LWS_PRE);\n        if (m < (int)amsg.len) {\n            LOG("ERROR %d writing to ws\\n", m);\n            // lwsl_err("ERROR %d writing to ws\\n", m);\n            return -1;\n        }\n        break;\n\n    case LWS_CALLBACK_RECEIVE:\n        if(len <= 0){\n            return -1;\n        }\n        LOG("[SoftAP]recv data = [%d]%s\\n", len, (const char *)in);\n        softap_property_setting_handle((const char *)in, len);\n        break;\n\n    default:\n        break;\n    }\n\n    return 0;\n}\n\nstatic struct lws_protocols protocols[] = {\n    // { "http", lws_callback_http_dummy, 0, 0 },\n    {\n        "local-ali-smartliving",\n        callback_smartliving,\n        sizeof(struct per_session_data__minimal),\n        MAX_RX_MSG_LEN,\n        0, NULL, MAX_TX_MSG_LEN\n    },\n    { NULL, NULL, 0, 0 } /* terminator */\n};\n\nstatic void websocket_server(void)\n{\n    struct lws_context_creation_info info;\n    struct lws_context *context;\n    const char *p;\n    int n = 0, logs = LLL_USER | LLL_ERR | LLL_WARN | LLL_NOTICE\n            /* for LLL_ verbosity above NOTICE to be built into lws,\n             * lws must have been configured and built with\n             * -DCMAKE_BUILD_TYPE=DEBUG instead of =RELEASE */\n            /* | LLL_INFO */ /* | LLL_PARSER */ /* | LLL_HEADER */\n            /* | LLL_EXT */ /* | LLL_CLIENT */ /* | LLL_LATENCY */\n            /* | LLL_DEBUG */;\n\n    lws_set_log_level(logs, NULL);\n\n    memset(&info, 0, sizeof info); /* otherwise uninitialized garbage */\n    info.port = SOCK_IN_PORT;\n    info.protocols = protocols;\n    info.max_http_header_pool = 5;\n    // info.vhost_name = "localhost";\n    // info.options =\n    //     LWS_SERVER_OPTION_HTTP_HEADERS_SECURITY_BEST_PRACTICES_ENFORCE;\n    info.options = LWS_SERVER_OPTION_VALIDATE_UTF8;\n\n    // info.ip_limit_ah = 3;\n    // info.ip_limit_wsi = 5;\n\n    context = lws_create_context(&info);\n    if (!context) {\n        LWIP_ASSERT("[SoftAP]WebSocket bind failed.", 0);\n        // return;\n    }\n\n    LOG("[SoftAP]enter websocket_server loop");\n    while (true)\n    {\n        while(!softap_launch){\n            aos_msleep(1000);\n        }\n\n        n = lws_service(context, 50);\n    }\n\n    lws_context_destroy(context);\n\n    LOG("[SoftAP]exit soft ap task");\n    aos_task_exit(0);\n}\n\nvoid softap_task(void)\n{\n    LOG("[SoftAP]enter soft ap task");\n    websocket_server();\n}\n\n\nint init_softap_flag()\n{\n    unsigned char value;\n    int ret, len = sizeof(value);\n\n    ret = aos_kv_get("soft ap flag", &value, &len);\n    if (ret == 0 && len > 0) {\n        softap_flag = value;\n        LOG("soft ap flag = %d", (int)value);\n    }else{\n        LOG("soft ap get err ret = %d", ret);\n        softap_flag = 1;\n        aos_kv_set("soft ap flag", &softap_flag, len, 1);\n    }\n    return 0;\n}\n\nint set_softap_flag(unsigned char value)\n{\n    int ret, len = sizeof(value);\n    softap_flag = value;\n    ret = aos_kv_set("soft ap flag", &value, len, 1);\n    if(ret != 0){\n        LOG("kv set failed ret = %d", ret);\n    }\n}\n\ninline const unsigned char get_softap_flag(void)\n{\n    return softap_flag;\n}\n'})}),"\n",(0,t.jsx)(n.h4,{id:"toolsbk7231udevkitcsh",children:"tools/bk7231udevkitc.sh"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'    if [[ "$2" == httpapp ]] || [[ "$2" == coapapp ]];then\n-       COMMON_LIBS="$p/$2.a  $p/board_bk7231u.a  $p/vcall.a  $p/kernel_init.a  $p/auto_component.a  $p/libiot_sdk.a $p/iotx-hal.a  $p/hal_init.a  $p/netmgr.a  $p/framework.a  $p/cjson.a   $p/cli.a   $p/$ARCH.a  $p/newlib_stub.a  $p/rhino.a  $p/digest_algorithm.a  $p/net.a  $p/log.a  $p/activation.a  $p/chip_code.a  $p/imbedtls.a  $p/kv.a  $p/yloop.a  $p/hal.a   $p/alicrypto.a  $p/vfs.a  $p/vfs_device.a   $p/awss_security.a $p/libaiotss.a "\n+       COMMON_LIBS="$p/$2.a  $p/mbedtls_wrapper.a  $p/libwebsockets.a  $p/board_bk7231u.a  $p/vcall.a  $p/kernel_init.a  $p/auto_component.a  $p/libiot_sdk.a $p/iotx-hal.a  $p/hal_init.a  $p/netmgr.a  $p/framework.a  $p/cjson.a   $p/cli.a   $p/$ARCH.a  $p/newlib_stub.a  $p/rhino.a  $p/digest_algorithm.a  $p/net.a  $p/log.a  $p/activation.a  $p/chip_code.a  $p/imbedtls.a  $p/kv.a  $p/yloop.a  $p/hal.a   $p/alicrypto.a  $p/vfs.a  $p/vfs_device.a   $p/awss_security.a $p/libaiotss.a "\n    else\n-       COMMON_LIBS="$p/$2.a  $p/board_bk7231u.a  $p/vcall.a  $p/kernel_init.a  $p/auto_component.a  $p/libiot_sdk.a $p/iotx-hal.a  $p/hal_init.a  $p/netmgr.a  $p/framework.a  $p/cjson.a  $p/ota.a  $p/cli.a  $p/ota_hal.a  $p/$ARCH.a  $p/newlib_stub.a  $p/rhino.a  $p/digest_algorithm.a  $p/net.a  $p/log.a  $p/activation.a  $p/chip_code.a  $p/imbedtls.a  $p/kv.a  $p/yloop.a  $p/hal.a  $p/ota_transport.a  $p/ota_download.a  $p/ota_verify.a  $p/base64.a  $p/alicrypto.a  $p/vfs.a  $p/vfs_device.a   $p/awss_security.a $p/libaiotss.a "\n+       COMMON_LIBS="$p/$2.a  $p/mbedtls_wrapper.a  $p/libwebsockets.a  $p/board_bk7231u.a  $p/vcall.a  $p/kernel_init.a  $p/auto_component.a  $p/libiot_sdk.a $p/iotx-hal.a  $p/hal_init.a  $p/netmgr.a  $p/framework.a  $p/cjson.a  $p/ota.a  $p/cli.a  $p/ota_hal.a  $p/$ARCH.a  $p/newlib_stub.a  $p/rhino.a  $p/digest_algorithm.a  $p/net.a  $p/log.a  $p/activation.a  $p/chip_code.a  $p/imbedtls.a  $p/kv.a  $p/yloop.a  $p/hal.a  $p/ota_transport.a  $p/ota_download.a  $p/ota_verify.a  $p/base64.a  $p/alicrypto.a  $p/vfs.a  $p/vfs_device.a   $p/awss_security.a $p/libaiotss.a "\n    fi\n'})})]})}function _(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(p,{...e})}):p(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>o,x:()=>l});var i=s(6540);const t={},a=i.createContext(t);function o(e){const n=i.useContext(a);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:o(e.components),i.createElement(a.Provider,{value:n},e.children)}}}]);